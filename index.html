<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Personal Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4CAF50; /* Green */
            --secondary-color: #2196F3; /* Blue */
            --accent-color: #FFC107; /* Amber */
            --background-dark: #2C2F33;
            --background-light: #F0F2F5;
            --card-bg-dark: #23272A;
            --card-bg-light: #FFFFFF;
            --text-dark: #FFFFFF;
            --text-light: #5C6F80;
            --border-color-dark: #36393F;
            --border-color-light: #E0E4E8;
            --red-color: #F44336;
            --orange-color: #FF9800;

            --progress-bar-bg: #e0e0e0;
            --progress-bar-fill-1: #8BC34A; /* Light green */
            --progress-bar-fill-2: #FFEB3B; /* Yellow */
            --progress-bar-fill-complete: #4CAF50; /* Primary green */

            --button-bg-primary: #4CAF50;
            --button-text-primary: #FFFFFF;
            --button-hover-primary: #43A047;

            --button-bg-secondary: #E0E0E0;
            --button-text-secondary: #333333;
            --button-hover-secondary: #D5D5D5;
        }

        /* Dark Theme */
        body.dark-theme {
            background-color: var(--background-dark);
            color: var(--text-dark);
        }
        body.dark-theme .widget,
        body.dark-theme .modal-content {
            background-color: var(--card-bg-dark);
            border-color: var(--border-color-dark);
            color: var(--text-dark);
        }
        body.dark-theme input[type="text"],
        body.dark-theme textarea,
        body.dark-theme input[type="time"],
        body.dark-theme .reminder-text[contenteditable="true"],
        body.dark-theme .card-title-text[contenteditable="true"],
        body.dark-theme .task-label[contenteditable="true"] {
            background-color: #36393F;
            border-color: var(--border-color-dark);
            color: var(--text-dark);
        }
        body.dark-theme .close-btn,
        body.dark-theme .calendar-nav button {
            color: var(--text-dark);
        }
        body.dark-theme .calendar-day {
            color: var(--text-dark);
        }
        body.dark-theme .calendar-day.selected {
            background-color: var(--primary-color);
            color: var(--text-dark);
        }
        body.dark-theme .calendar-day.today {
            border: 1px solid var(--accent-color);
        }
        body.dark-theme .reminder-dot {
            background-color: var(--accent-color);
        }
        body.dark-theme .progress-bar-container {
            background-color: #444;
        }
        body.dark-theme .mood-emoji-trigger {
            background-color: #444;
        }
        body.dark-theme .mood-emoji-trigger:hover {
            background-color: #555;
        }
        body.dark-theme .log-details .log-timestamp {
            color: var(--text-light);
        }
        body.dark-theme .tab-button {
            background-color: var(--card-bg-dark);
            color: var(--text-dark);
            border-color: var(--border-color-dark);
        }
        body.dark-theme .tab-button.active {
            background-color: var(--primary-color);
            color: var(--text-dark);
        }

        /* Light Theme */
        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--background-light);
            color: #333;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .widget {
            background-color: var(--card-bg-light);
            border: 1px solid var(--border-color-light);
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
            padding: 20px;
            width: 100%;
            max-width: 450px; /* Reduced max-width for better fit */
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .widget-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        h1, h2, h3, h4 {
            color: var(--primary-color);
            margin-top: 0;
        }
        h1 {
            font-size: 2.2em;
            font-weight: 700;
            color: #333; /* Always dark for main title */
        }
        body.dark-theme h1 {
             color: var(--text-dark); /* White for main title in dark theme */
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5em;
            color: #888;
            cursor: pointer;
            transition: color 0.2s ease;
        }
        .close-btn:hover {
            color: var(--red-color);
        }

        /* Dashboard Layout */
        .dashboard-header {
            width: 100%;
            max-width: 960px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 0 10px;
        }
        .main-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            width: 100%;
            max-width: 960px;
        }

        /* Theme Toggle */
        .theme-switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
        }
        .theme-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 20px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: var(--primary-color);
        }
        input:focus + .slider {
            box-shadow: 0 0 1px var(--primary-color);
        }
        input:checked + .slider:before {
            transform: translateX(20px);
        }

        /* Motivational Quote */
        .quote-container {
            text-align: center;
        }
        .quote-container p {
            font-size: 1.1em;
            font-style: italic;
            margin-bottom: 15px;
            line-height: 1.5;
        }
        .quote-container button {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s ease;
        }
        .quote-container button:hover {
            background-color: #1976D2;
        }

        /* To-Do List Widget */
        .todo-card .task-list {
            list-style: none;
            padding: 0;
            margin-bottom: 15px;
        }
        .todo-card .task-list li {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color-light);
            transition: border-color 0.3s ease;
            position: relative; /* For due date button positioning */
        }
        body.dark-theme .todo-card .task-list li {
            border-color: var(--border-color-dark);
        }
        .todo-card .task-list li:last-child {
            border-bottom: none;
        }
        .todo-card .task-list li input[type="checkbox"] {
            margin-right: 10px;
            min-width: 18px; /* Ensure checkbox size consistency */
            min-height: 18px;
            cursor: pointer;
            accent-color: var(--primary-color); /* For checked state */
        }
        .todo-card .task-list li .task-label {
            flex-grow: 1;
            padding: 2px 0;
            outline: none;
            cursor: text;
            min-width: 50px; /* Ensure it's always editable */
        }
        .todo-card .task-list li input[type="checkbox"]:checked + .task-label {
            text-decoration: line-through;
            color: var(--text-light);
        }
        .todo-card .add-task-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            font-size: 1em;
            transition: background-color 0.3s ease;
            margin-top: 10px;
        }
        .todo-card .add-task-btn:hover {
            background-color: #43A047;
        }
        .todo-card .progress-item {
            margin-top: 20px;
            text-align: center;
        }
        .todo-card .progress-bar-container {
            width: 100%;
            background-color: var(--progress-bar-bg);
            border-radius: 5px;
            height: 10px;
            overflow: hidden;
            margin-bottom: 8px;
        }
        .todo-card .progress-bar {
            height: 100%;
            width: 0%;
            background-color: var(--progress-bar-fill-1);
            border-radius: 5px;
            transition: width 0.4s ease-in-out, background-color 0.3s ease;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.7em;
            color: white;
            font-weight: bold;
        }
        .todo-card .progress-bar.full {
            background-color: var(--progress-bar-fill-complete);
        }
        .todo-card .progress-label {
            font-size: 0.9em;
            color: var(--text-light);
        }
        .new-page-btn-container {
            width: 100%;
            max-width: 450px;
            text-align: center;
            margin-bottom: 20px;
        }
        #newPageBtn {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: background-color 0.3s ease;
        }
        #newPageBtn:hover {
            background-color: #1976D2;
        }

        /* Task Due Date Styling */
        .task-due-date {
            font-size: 0.8em;
            color: var(--text-light); /* Softer color for date */
            margin-left: 10px;
            white-space: nowrap; /* Prevent date from wrapping */
        }

        .task-due-date.overdue {
            color: var(--red-color); /* Overdue color */
            font-weight: bold;
        }

        .task-due-date.today {
            color: var(--orange-color); /* Due today color */
            font-weight: bold;
        }

        .task-due-date.completed {
            text-decoration: line-through;
            color: var(--text-light);
        }
        
        .set-due-date-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.1em;
            margin-left: auto; /* Push to the right */
            color: var(--secondary-color);
            transition: color 0.2s ease;
        }
        .set-due-date-btn:hover {
            color: #1976D2;
        }

        /* Reminders Widget */
        .reminders-list {
            list-style: none;
            padding: 0;
            margin-bottom: 15px;
        }
        .reminders-list li {
            display: flex;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color-light);
        }
        body.dark-theme .reminders-list li {
            border-color: var(--border-color-dark);
        }
        .reminders-list li:last-child {
            border-bottom: none;
        }
        .reminders-list .reminder-checkbox {
            margin-right: 10px;
            min-width: 18px;
            min-height: 18px;
            cursor: pointer;
            accent-color: var(--primary-color);
        }
        .reminders-list .reminder-details {
            flex-grow: 1;
        }
        .reminders-list .reminder-text {
            font-weight: bold;
        }
        .reminders-list .reminder-text.completed {
            text-decoration: line-through;
            color: var(--text-light);
        }
        .reminders-list .reminder-date {
            font-size: 0.85em;
            color: var(--text-light);
        }
        .reminders-list .delete-reminder-btn {
            background: none;
            border: none;
            color: var(--red-color);
            font-size: 1.5em;
            margin-left: 10px;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        .reminders-list .delete-reminder-btn:hover {
            transform: scale(1.2);
        }
        .new-reminder-input-group {
            display: flex;
            gap: 10px;
        }
        .new-reminder-input-group input[type="text"] {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid var(--border-color-light);
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }
        .new-reminder-input-group input[type="text"]:focus {
            border-color: var(--primary-color);
            outline: none;
        }
        .new-reminder-input-group button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s ease;
        }
        .new-reminder-input-group button:hover {
            background-color: #43A047;
        }

        /* Modals (shared styles) */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 1;
            transition: opacity 0.4s ease-in-out;
        }
        .modal-overlay.fade-out {
            opacity: 0;
        }
        .modal-content {
            background-color: var(--card-bg-light);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 500px;
            transform: translateY(0);
            transition: transform 0.3s ease-out;
        }
        .modal-overlay.fade-out .modal-content {
            transform: translateY(-20px);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .modal-header h3 {
            margin: 0;
            color: var(--primary-color);
        }
        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        /* Calendar specific modal styles */
        .calendar-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .calendar-nav button {
            background: none;
            border: none;
            font-size: 1.8em;
            color: var(--secondary-color);
            cursor: pointer;
            transition: color 0.2s ease;
        }
        .calendar-nav button:hover {
            color: #1976D2;
        }
        .calendar-nav h4 {
            margin: 0;
            color: #333;
        }
        body.dark-theme .calendar-nav h4 {
            color: var(--text-dark);
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            text-align: center;
        }
        .calendar-day-name {
            font-weight: bold;
            color: var(--text-light);
            padding: 5px 0;
        }
        .calendar-day {
            padding: 10px 0;
            cursor: pointer;
            border-radius: 8px;
            transition: background-color 0.2s ease, color 0.2s ease;
            position: relative;
        }
        .calendar-day:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }
        .calendar-day.today {
            border: 2px solid var(--primary-color);
            font-weight: bold;
        }
        .calendar-day.selected {
            background-color: var(--primary-color);
            color: white;
        }
        .reminder-dot {
            position: absolute;
            bottom: 3px;
            left: 50%;
            transform: translateX(-50%);
            width: 6px;
            height: 6px;
            background-color: var(--primary-color);
            border-radius: 50%;
        }

        /* Mood Tracker Widget */
        .mood-emoji-selection {
            display: flex;
            justify-content: space-around;
            margin-top: 15px;
            margin-bottom: 20px;
        }
        .mood-emoji-trigger {
            font-size: 2.5em;
            cursor: pointer;
            transition: transform 0.2s ease;
            padding: 8px;
            border-radius: 50%;
            background-color: #F8F8F8;
        }
        .mood-emoji-trigger:hover {
            transform: scale(1.1);
            background-color: #EFEFEF;
        }
        .mood-log-entry {
            margin-top: 15px;
        }
        .mood-log-entry textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color-light);
            border-radius: 8px;
            font-size: 1em;
            min-height: 80px;
            resize: vertical;
        }
        .mood-log-list {
            list-style: none;
            padding: 0;
            margin-top: 15px;
        }
        .mood-log-list li {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color-light);
        }
        body.dark-theme .mood-log-list li {
            border-color: var(--border-color-dark);
        }
        .mood-log-list li:last-child {
            border-bottom: none;
        }
        .log-emoji {
            font-size: 1.8em;
            margin-right: 10px;
        }
        .log-details {
            flex-grow: 1;
        }
        .log-note {
            margin: 0;
            font-weight: bold;
        }
        .log-timestamp {
            font-size: 0.8em;
            color: var(--text-light);
        }
        .empty-log-message, .empty-full-log-message {
            text-align: center;
            color: var(--text-light);
            font-style: italic;
            padding: 10px 0;
        }

        /* Full Mood Log View Modal */
        #fullMoodLogViewModal .modal-content {
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        #fullLogListContainer {
            list-style: none;
            padding: 0;
        }
        #fullLogListContainer li {
            border-bottom: 1px solid var(--border-color-light);
            padding: 10px 0;
            display: flex;
            align-items: flex-start;
        }
        body.dark-theme #fullLogListContainer li {
            border-color: var(--border-color-dark);
        }
        #fullLogListContainer li:last-child {
            border-bottom: none;
        }
        #fullLogListContainer .log-details {
            margin-top: 5px; /* Adjust alignment with emoji */
        }
        #fullLogListContainer .log-timestamp {
            font-size: 0.75em;
            margin-top: 5px;
        }
        .tab-buttons {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }
        .tab-button {
            background-color: var(--button-bg-secondary);
            color: var(--button-text-secondary);
            border: 1px solid var(--border-color-light);
            border-radius: 8px;
            padding: 10px 15px;
            margin: 0 5px;
            cursor: pointer;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .tab-button:hover {
            background-color: var(--button-hover-secondary);
        }
        .tab-button.active {
            background-color: var(--primary-color);
            color: var(--button-text-primary);
            border-color: var(--primary-color);
        }

        /* Zodiac Prediction Widget */
        .zodiac-prediction {
            text-align: center;
        }
        .zodiac-prediction p {
            font-style: italic;
            min-height: 2em; /* Ensure space even if no prediction */
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px 0;
        }
        .zodiac-prediction a {
            color: var(--secondary-color);
            text-decoration: none;
            font-weight: bold;
            transition: color 0.2s ease;
        }
        .zodiac-prediction a:hover {
            color: #1976D2;
            text-decoration: underline;
        }

        /* Confetti */
        #confetti-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* Allows clicks to pass through */
            overflow: hidden;
            z-index: 1000;
        }
        .confetti-piece {
            position: absolute;
            width: 10px;
            height: 20px;
            background-color: #FFD700; /* Example color */
            animation: fall 3s ease-out forwards;
            opacity: 0;
        }
        @keyframes fall {
            0% {
                transform: translateY(0) rotateZ(0deg);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotateZ(720deg);
                opacity: 0;
            }
        }

        /* Search Bar */
        .search-container {
            display: flex;
            margin-bottom: 20px;
            gap: 10px;
        }
        .search-container input {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid var(--border-color-light);
            border-radius: 8px;
            font-size: 1em;
        }
        .search-container button {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s ease;
        }
        .search-container button:hover {
            background-color: #1976D2;
        }

        /* Responsive Adjustments */
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            .dashboard-header {
                flex-direction: column;
                gap: 20px;
            }
            h1 {
                font-size: 1.8em;
            }
            .widget {
                padding: 15px;
            }
        }

        /* Modal for setting task due date */
        .task-date-modal .modal-content {
            width: 90%;
            max-width: 400px;
        }

        /* Ensure consistent button styling across modals */
        .modal-actions button {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s ease;
        }

        .modal-actions .cancel-btn {
            background-color: var(--button-bg-secondary);
            color: var(--button-text-secondary);
        }

        .modal-actions .cancel-btn:hover {
            background-color: var(--button-hover-secondary);
        }

        .modal-actions .save-btn {
            background-color: var(--button-bg-primary);
            color: var(--button-text-primary);
        }

        .modal-actions .save-btn:hover {
            background-color: var(--button-hover-primary);
        }

    </style>
</head>
<body class="light-theme">
    <div class="dashboard-header">
        <h1>My Personal Dashboard</h1>
        <label class="theme-switch">
            <input type="checkbox" id="themeToggle">
            <span class="slider"></span>
        </label>
    </div>

    <div class="main-content">
        <section class="widget quote-container">
            <div class="widget-header">
                <h2>Daily Wisdom</h2>
            </div>
            <p id="motivationalQuote">"The only way to do great work is to love what you do."</p>
            <button id="changeQuoteBtn">New Quote</button>
        </section>

        <section class="widget search-container">
            <div class="widget-header">
                <h2>Search</h2>
            </div>
            <input type="text" id="searchInput" placeholder="Search anything...">
            <button id="searchButton">Go</button>
        </section>

        <div id="widgetsContainer">
            </div>

        <div class="new-page-btn-container">
            <button id="newPageBtn">Add New To-Do List</button>
        </div>

        <section class="widget">
            <div class="widget-header">
                <h2>Reminders</h2>
            </div>
            <ul id="remindersList" class="reminders-list">
                </ul>
            <div class="new-reminder-input-group">
                <input type="text" id="newReminderInput" placeholder="Add a new reminder...">
                <button id="addReminderBtn">Set Date</button>
            </div>
        </section>

        <section class="widget">
            <div class="widget-header">
                <h2>Mood Tracker</h2>
                <div class="tab-buttons">
                    <button class="tab-button active" id="summaryMoodLogTabBtn">Summary</button>
                    <button class="tab-button" id="viewMoodLogTabBtn">View All</button>
                </div>
            </div>
            <div class="mood-emoji-selection">
                <span class="mood-emoji-trigger" data-mood="happy" data-emoji="üòä">üòä</span>
                <span class="mood-emoji-trigger" data-mood="neutral" data-emoji="üòê">üòê</span>
                <span class="mood-emoji-trigger" data-mood="sad" data-emoji="üòî">üòî</span>
                <span class="mood-emoji-trigger" data-mood="stressed" data-emoji="üò©">üò©</span>
                <span class="mood-emoji-trigger" data-mood="excited" data-emoji="ü§©">ü§©</span>
            </div>
            <div class="mood-log-entry">
                <ul id="moodLogListSummary" class="mood-log-list">
                    </ul>
            </div>
        </section>

        <section class="widget zodiac-prediction">
            <div class="widget-header">
                <h2>Your Zodiac Prediction</h2>
            </div>
            <p id="zodiacPredictionText">Click below for your daily cosmic insight!</p>
            <a href="#" id="zodiacLink">Get Your Prediction</a>
        </section>

    </div> <div id="reminderCalendarModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Set Reminder Date & Time</h3>
                <button id="closeCalendarModalBtn" class="close-btn" title="Close Date Picker">√ó</button>
            </div>
            <div class="calendar-nav">
                <button id="prevMonthBtn" title="Previous Month">&lt;</button>
                <h4 id="calendarMonthYear">Month Year</h4>
                <button id="nextMonthBtn" title="Next Month">&gt;</button>
            </div>
            <div id="calendarGrid" class="calendar-grid">
                </div>
            <div class="reminder-time-input">
                <label for="reminderTimeInput">Time:</label>
                <input type="time" id="reminderTimeInput">
            </div>
            <div class="modal-actions">
                <button id="cancelReminderBtn" class="cancel-btn">Cancel</button>
                <button id="setReminderBtn" class="save-btn">Set Reminder</button>
            </div>
        </div>
    </div>

    <div id="moodLoggingModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Log Your Mood <span id="modalSelectedMoodEmoji"></span></h3>
                <button id="cancelMoodLogBtn" class="close-btn" title="Close Mood Log">√ó</button>
            </div>
            <textarea id="moodNoteInput" placeholder="Add a note about why you feel this way... (optional)"></textarea>
            <div class="modal-actions">
                <button id="saveMoodLogBtn" class="save-btn">Save Mood Log</button>
            </div>
        </div>
    </div>

    <div id="fullMoodLogViewModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Your Full Mood Log</h3>
                <button id="closeFullLogViewBtn" class="close-btn" title="Close Full Log">√ó</button>
            </div>
            <ul id="fullLogListContainer">
                </ul>
        </div>
    </div>

    <div id="taskDueDateModal" class="modal-overlay task-date-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="taskDateModalTitle">Set Due Date for Task</h3>
                <button id="closeTaskDateModalBtn" class="close-btn" title="Close Date Picker">√ó</button>
            </div>
            <div class="calendar-nav">
                <button id="prevTaskMonthBtn" title="Previous Month">&lt;</button>
                <h4 id="taskCalendarMonthYear">Month Year</h4>
                <button id="nextTaskMonthBtn" title="Next Month">&gt;</button>
            </div>
            <div id="taskCalendarGrid" class="calendar-grid">
                </div>
            <div class="modal-actions">
                <button id="clearTaskDueDateBtn" class="cancel-btn">Clear Due Date</button>
                <button id="setTaskDueDateBtn" class="save-btn">Set Due Date</button>
            </div>
        </div>
    </div>

    <div id="confetti-container"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Global Variables and DOM Elements ---
            const themeToggle = document.getElementById('themeToggle');
            const motivationalQuoteEl = document.getElementById('motivationalQuote');
            const changeQuoteBtn = document.getElementById('changeQuoteBtn');
            const widgetsContainer = document.getElementById('widgetsContainer');

            // --- Motivational Quotes ---
            const quotes = [
                "The only way to do great work is to love what you do. ‚Äì Steve Jobs",
                "Believe you can and you're halfway there. ‚Äì Theodore Roosevelt",
                "The future belongs to those who believe in the beauty of their dreams. ‚Äì Eleanor Roosevelt",
                "It always seems impossible until it's done. ‚Äì Nelson Mandela",
                "Success is not final, failure is not fatal: it is the courage to continue that counts. ‚Äì Winston Churchill",
                "The best way to predict the future is to create it. ‚Äì Peter Drucker",
                "The only limit to our realization of tomorrow will be our doubts of today. ‚Äì Franklin D. Roosevelt"
            ];
            function displayRandomQuote() {
                if (motivationalQuoteEl) {
                    const randomIndex = Math.floor(Math.random() * quotes.length);
                    motivationalQuoteEl.textContent = quotes[randomIndex];
                }
            }
            if (changeQuoteBtn) changeQuoteBtn.addEventListener('click', displayRandomQuote);
            displayRandomQuote(); // Display a quote on load

            // --- Helper to select content for editable elements ---
            function selectElementContents(el) {
                const range = document.createRange();
                range.selectNodeContents(el);
                const sel = window.getSelection();
                sel.removeAllRanges();
                sel.addRange(range);
            }

            // --- Theme Toggle ---
            if (themeToggle) {
                // Load saved theme preference
                const savedTheme = localStorage.getItem('theme');
                if (savedTheme === 'dark') {
                    document.body.classList.add('dark-theme');
                    themeToggle.checked = true;
                } else {
                    document.body.classList.remove('dark-theme');
                    themeToggle.checked = false;
                }

                themeToggle.addEventListener('change', () => {
                    if (themeToggle.checked) {
                        document.body.classList.add('dark-theme');
                        localStorage.setItem('theme', 'dark');
                    } else {
                        document.body.classList.remove('dark-theme');
                        localStorage.setItem('theme', 'light');
                    }
                });
            }

            // --- To-Do List Widget ---
            let cardIdCounter = 0;
            let globalTaskCounter = 0;
            let currentOpenTaskForDate = null; // To store the task being edited for date setting

            // --- LOCAL STORAGE KEY CONSTANTS ---
            const LOCAL_STORAGE_TODO_KEY = 'todoCards';

            // --- HELPER FUNCTIONS FOR LOCAL STORAGE ---
            function loadTodoCards() {
                const storedCards = localStorage.getItem(LOCAL_STORAGE_TODO_KEY);
                if (storedCards) {
                    const cardsData = JSON.parse(storedCards);
                    // Reset counters based on loaded data to prevent ID collisions
                    cardIdCounter = 0;
                    globalTaskCounter = 0;

                    if (cardsData.length > 0) {
                        cardIdCounter = Math.max(...cardsData.map(card => parseInt(card.id.split('-')[1] || 0)));
                        cardsData.forEach(card => {
                            if (card.tasks && card.tasks.length > 0) {
                                globalTaskCounter = Math.max(globalTaskCounter, ...card.tasks.map(task => parseInt(task.id.split('-')[2] || 0)));
                            }
                        });
                    }

                    // Clear existing default card before loading
                    if (widgetsContainer) {
                        widgetsContainer.innerHTML = '';
                    }

                    cardsData.forEach(cardData => {
                        createTodoCard(cardData); // Pass data to recreate card
                    });
                } else {
                    // Create a default card if no stored data
                    createTodoCard();
                }
            }

            function saveTodoCards() {
                const todoCards = [];
                document.querySelectorAll('.todo-card').forEach(cardElement => {
                    const cardId = cardElement.id;
                    const cardTitle = cardElement.querySelector('.card-title-text').textContent.trim();
                    const tasks = [];
                    cardElement.querySelectorAll('.task-list li').forEach(taskItem => {
                        const checkbox = taskItem.querySelector('input[type="checkbox"]');
                        const label = taskItem.querySelector('.task-label');
                        const dueDateSpan = taskItem.querySelector('.task-due-date');
                        tasks.push({
                            id: checkbox.id,
                            text: label.textContent.trim(),
                            completed: checkbox.checked,
                            dueDate: dueDateSpan ? dueDateSpan.dataset.dueDate : null // Save due date
                        });
                    });
                    todoCards.push({ id: cardId, title: cardTitle, tasks: tasks });
                });
                localStorage.setItem(LOCAL_STORAGE_TODO_KEY, JSON.stringify(todoCards));
            }


            // --- TODO CARD FUNCTIONALITY ---
            function createTodoCard(cardData = null) {
                cardIdCounter++;
                const cardId = cardData ? cardData.id : `todoCard-${cardIdCounter}`;
                const cardElement = document.createElement('section');
                cardElement.classList.add('widget', 'todo-card');
                cardElement.id = cardId;
                cardElement.innerHTML = `
                    <div class="widget-header">
                        <h2 class="card-title"><span class="card-title-text" contenteditable="true">${cardData ? cardData.title : `Untitled List ${cardIdCounter}`}</span></h2>
                        <button class="close-btn close-card-btn" title="Close this list">√ó</button>
                    </div>
                    <ul class="task-list"></ul>
                    <button class="add-task-btn">+ Add New Task</button>
                    <div class="progress-item">
                        <div class="progress-bar-container"><div class="progress-bar"></div></div>
                        <p class="progress-label">0% Complete</p>
                    </div>`;
                if (widgetsContainer) {
                    widgetsContainer.appendChild(cardElement);

                    const taskList = cardElement.querySelector('.task-list');

                    if (cardData && cardData.tasks) {
                        cardData.tasks.forEach(task => addTaskToTodoCard(cardElement, task.text, task.completed, task.dueDate));
                    } else {
                        addTaskToTodoCard(cardElement, "New Task");
                    }

                    updateProgressForCard(cardElement);
                    const cardTitleText = cardElement.querySelector('.card-title-text');
                    if (cardTitleText) {
                        cardTitleText.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); cardTitleText.blur();}});
                        cardTitleText.addEventListener('blur', saveTodoCards); // Save on title change
                        if (!cardData) { // Only focus on new cards
                            cardTitleText.focus();
                            selectElementContents(cardTitleText);
                        }
                    }
                }
                saveTodoCards(); // Save after creating a new card
            }

            function addTaskToTodoCard(cardElement, taskText = "New Task", completed = false, dueDate = null) {
                globalTaskCounter++;
                const taskId = `dynamic-task-${globalTaskCounter}`;
                const taskList = cardElement.querySelector('.task-list');
                if (!taskList) return;
                const taskItem = document.createElement('li');
                taskItem.innerHTML = `
                    <input type="checkbox" id="${taskId}" data-task-name="${taskText}" ${completed ? 'checked' : ''}>
                    <span class="task-label" contenteditable="true">${taskText}</span>
                    <span class="task-due-date"></span>
                    <button class="set-due-date-btn" title="Set Due Date">üìÖ</button>`; // Added due date button
                taskList.appendChild(taskItem);

                const newLabel = taskItem.querySelector('.task-label');
                const checkbox = taskItem.querySelector('input[type="checkbox"]');
                const dueDateSpan = taskItem.querySelector('.task-due-date');
                const setDueDateBtn = taskItem.querySelector('.set-due-date-btn');

                // Set initial due date if provided
                if (dueDate) {
                    dueDateSpan.dataset.dueDate = dueDate;
                    updateTaskDueDateDisplay(dueDateSpan, checkbox.checked);
                }

                if (newLabel) {
                    newLabel.focus();
                    selectElementContents(newLabel);
                    newLabel.addEventListener('blur', () => {
                        if(checkbox) checkbox.dataset.taskName = newLabel.textContent.trim();
                        updateProgressForCard(cardElement);
                        saveTodoCards(); // Save on task text change
                    });
                    newLabel.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); newLabel.blur();}});
                }

                checkbox.addEventListener('change', () => {
                    if (checkbox.checked) {
                        triggerConfetti();
                        dueDateSpan.classList.add('completed');
                    } else {
                        dueDateSpan.classList.remove('completed');
                    }
                    updateTaskDueDateDisplay(dueDateSpan, checkbox.checked); // Update display on check/uncheck
                    updateProgressForCard(cardElement);
                    saveTodoCards(); // Save on task completion change
                });

                setDueDateBtn.addEventListener('click', () => {
                    currentOpenTaskForDate = {
                        dueDateSpan: dueDateSpan,
                        checkbox: checkbox
                    };
                    openTaskDateModal(dueDate); // Pass existing due date to modal
                });

                updateProgressForCard(cardElement);
                saveTodoCards(); // Save after adding a new task
            }

            // --- NEW: Task Due Date Modal Logic ---
            const taskDueDateModal = document.getElementById('taskDueDateModal');
            const closeTaskDateModalBtn = document.getElementById('closeTaskDateModalBtn');
            const prevTaskMonthBtn = document.getElementById('prevTaskMonthBtn');
            const nextTaskMonthBtn = document.getElementById('nextTaskMonthBtn');
            const taskCalendarMonthYearEl = document.getElementById('taskCalendarMonthYear');
            const taskCalendarGridEl = document.getElementById('taskCalendarGrid');
            const setTaskDueDateBtn = document.getElementById('setTaskDueDateBtn');
            const clearTaskDueDateBtn = document.getElementById('clearTaskDueDateBtn');

            let taskCalendarDate = new Date();
            let selectedTaskDate = null;

            function openTaskDateModal(initialDueDate = null) {
                if (initialDueDate) {
                    selectedTaskDate = new Date(initialDueDate);
                    taskCalendarDate = new Date(initialDueDate); // Align calendar to existing date
                } else {
                    selectedTaskDate = new Date(); // Default to today
                    taskCalendarDate = new Date();
                }
                generateTaskCalendar();
                taskDueDateModal.classList.remove('fade-out');
                taskDueDateModal.style.display = 'flex';
            }

            function closeTaskDateModal() {
                taskDueDateModal.classList.add('fade-out');
                setTimeout(() => {
                    taskDueDateModal.style.display = 'none';
                    currentOpenTaskForDate = null; // Clear the task reference
                }, 400);
            }

            function generateTaskCalendar() {
                taskCalendarGridEl.innerHTML = '';
                const month = taskCalendarDate.getMonth();
                const year = taskCalendarDate.getFullYear();

                taskCalendarMonthYearEl.textContent = `${taskCalendarDate.toLocaleString('default', { month: 'long' })} ${year}`;

                const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                dayNames.forEach(day => {
                    const dayNameEl = document.createElement('div');
                    dayNameEl.classList.add('calendar-day-name');
                    dayNameEl.textContent = day;
                    taskCalendarGridEl.appendChild(dayNameEl);
                });

                const firstDayOfMonth = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();

                for (let i = 0; i < firstDayOfMonth; i++) {
                    taskCalendarGridEl.appendChild(document.createElement('div'));
                }

                for (let i = 1; i <= daysInMonth; i++) {
                    const dayEl = document.createElement('div');
                    dayEl.classList.add('calendar-day');
                    dayEl.textContent = i;
                    dayEl.dataset.date = new Date(year, month, i).toISOString();

                    const today = new Date();
                    const currentDay = new Date(year, month, i);

                    // Add 'today' class if it's the current date
                    if (currentDay.getDate() === today.getDate() && currentDay.getMonth() === today.getMonth() && currentDay.getFullYear() === today.getFullYear()) {
                        dayEl.classList.add('today');
                    }

                    // Add 'selected' class if it's the selected date
                    if (selectedTaskDate && currentDay.getDate() === selectedTaskDate.getDate() && currentDay.getMonth() === selectedTaskDate.getMonth() && currentDay.getFullYear() === selectedTaskDate.getFullYear()) {
                        dayEl.classList.add('selected');
                    }

                    dayEl.addEventListener('click', () => {
                        selectedTaskDate = new Date(year, month, i);
                        document.querySelectorAll('#taskCalendarGrid .calendar-day.selected').forEach(d => d.classList.remove('selected'));
                        dayEl.classList.add('selected');
                    });
                    taskCalendarGridEl.appendChild(dayEl);
                }
            }

            prevTaskMonthBtn.addEventListener('click', () => {
                taskCalendarDate.setMonth(taskCalendarDate.getMonth() - 1);
                generateTaskCalendar();
            });

            nextTaskMonthBtn.addEventListener('click', () => {
                taskCalendarDate.setMonth(taskCalendarDate.getMonth() + 1);
                generateTaskCalendar();
            });

            setTaskDueDateBtn.addEventListener('click', () => {
                if (currentOpenTaskForDate && selectedTaskDate) {
                    const dueDateISO = selectedTaskDate.toISOString();
                    currentOpenTaskForDate.dueDateSpan.dataset.dueDate = dueDateISO;
                    updateTaskDueDateDisplay(currentOpenTaskForDate.dueDateSpan, currentOpenTaskForDate.checkbox.checked);
                    saveTodoCards(); // Save after setting due date
                }
                closeTaskDateModal();
            });

            clearTaskDueDateBtn.addEventListener('click', () => {
                if (currentOpenTaskForDate) {
                    currentOpenTaskForDate.dueDateSpan.removeAttribute('data-due-date');
                    updateTaskDueDateDisplay(currentOpenTaskForDate.dueDateSpan, currentOpenTaskForDate.checkbox.checked);
                    saveTodoCards(); // Save after clearing due date
                }
                closeTaskDateModal();
            });

            closeTaskDateModalBtn.addEventListener('click', closeTaskDateModal);

            // --- NEW: Function to update task due date display and class ---
            function updateTaskDueDateDisplay(dueDateSpan, isCompleted) {
                if (!dueDateSpan) return;

                const dueDate = dueDateSpan.dataset.dueDate;
                dueDateSpan.textContent = '';
                dueDateSpan.className = 'task-due-date'; // Reset classes

                if (!dueDate) return;

                const date = new Date(dueDate);
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const taskDateOnly = new Date(date.getFullYear(), date.getMonth(), date.getDate());

                let displayString = '';
                let isOverdue = false;

                if (taskDateOnly.getTime() < today.getTime() && !isCompleted) {
                    isOverdue = true;
                }

                if (taskDateOnly.getTime() === today.getTime()) {
                    displayString = `Today ${date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
                    dueDateSpan.classList.add('today');
                } else if (taskDateOnly.getTime() > today.getTime() && (taskDateOnly.getTime() - today.getTime()) < (24 * 60 * 60 * 1000)) { // Tomorrow
                    displayString = `Tomorrow ${date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
                } else {
                    displayString = date.toLocaleDateString([], { month: 'short', day: 'numeric', year: 'numeric' });
                    // Only add time if it's not midnight (i.e., a specific time was set)
                    if (date.getHours() !== 0 || date.getMinutes() !== 0) {
                        displayString += ` ${date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
                    }
                }

                dueDateSpan.textContent = displayString;

                if (isOverdue) {
                    dueDateSpan.classList.add('overdue');
                }
                if (isCompleted) {
                    dueDateSpan.classList.add('completed');
                }
            }


            function updateProgressForCard(cardElement) {
                const checkboxes = cardElement.querySelectorAll('.task-list input[type="checkbox"]');
                const progressBar = cardElement.querySelector('.progress-bar');
                const progressLabel = cardElement.querySelector('.progress-label');
                if (!progressBar || !progressLabel) return;
                const totalTasks = checkboxes.length;
                let checkedTasks = 0;
                checkboxes.forEach(cb => { if (cb.checked) checkedTasks++; });
                const percentage = totalTasks === 0 ? 0 : Math.round((checkedTasks / totalTasks) * 100);
                progressBar.style.width = `${percentage}%`;
                progressBar.textContent = `${percentage}%`;
                progressLabel.textContent = `${checkedTasks} of ${totalTasks} tasks complete (${percentage}%)`;
                if (percentage === 100 && totalTasks > 0) {
                    progressBar.classList.add('full');
                    progressBar.style.backgroundColor = 'var(--progress-bar-fill-complete)';
                } else {
                    progressBar.classList.remove('full');
                    progressBar.style.backgroundColor = percentage < 50 ? 'var(--progress-bar-fill-1)' : 'var(--progress-bar-fill-2)';
                }
                saveTodoCards(); // Save whenever progress updates (which means task status changed)
            }


            if (widgetsContainer) {
                widgetsContainer.addEventListener('click', function(event) {
                    const target = event.target;
                    if (target.classList.contains('add-task-btn')) {
                        const cardElement = target.closest('.todo-card');
                        if (cardElement) addTaskToTodoCard(cardElement);
                    }
                    if (target.classList.contains('close-card-btn')) {
                        const cardElement = target.closest('.todo-card');
                        if (cardElement) {
                            cardElement.remove();
                            saveTodoCards(); // Save after removing a card
                        }
                    }
                });
                widgetsContainer.addEventListener('change', function(event) {
                    const target = event.target;
                    if (target.matches('.todo-card .task-list input[type="checkbox"]')) {
                        const cardElement = target.closest('.todo-card');
                        if (cardElement) {
                            // Confetti trigger is already in addTaskToTodoCard's change listener
                            updateProgressForCard(cardElement);
                        }
                    }
                });
            }

            const newPageButton = document.getElementById('newPageBtn');
            if (newPageButton) newPageButton.addEventListener('click', () => createTodoCard()); // Call with no data for new card

            // --- Reminders ---
            const remindersListEl = document.getElementById('remindersList');
            const newReminderInput = document.getElementById('newReminderInput');
            const addReminderBtn = document.getElementById('addReminderBtn');
            const reminderCalendarModal = document.getElementById('reminderCalendarModal');
            const closeCalendarModalBtn = document.getElementById('closeCalendarModalBtn');
            const prevMonthBtn = document.getElementById('prevMonthBtn');
            const nextMonthBtn = document.getElementById('nextMonthBtn');
            const calendarMonthYearEl = document.getElementById('calendarMonthYear');
            const calendarGridEl = document.getElementById('calendarGrid');
            const reminderTimeInput = document.getElementById('reminderTimeInput');
            const setReminderBtn = document.getElementById('setReminderBtn');
            const cancelReminderBtn = document.getElementById('cancelReminderBtn');

            let reminders = [];
            let reminderTextToSet = '';
            let calendarDate = new Date(); // Date displayed in the calendar modal
            let selectedDate = null; // Date chosen by the user in the calendar modal

            function loadReminders() {
                reminders = JSON.parse(localStorage.getItem('reminders') || '[]');
                renderReminders();
            }

            function saveReminders() {
                localStorage.setItem('reminders', JSON.stringify(reminders));
            }

            function requestNotificationPermission() {
                if ('Notification' in window) {
                    if (Notification.permission !== 'granted' && Notification.permission !== 'denied') {
                        Notification.requestPermission().then(permission => {
                            if (permission === 'granted') {
                                console.log('Notification permission granted.');
                            } else {
                                console.warn('Notification permission denied.');
                            }
                        });
                    }
                }
            }

            function showNotification(title, body) {
                if ('Notification' in window && Notification.permission === 'granted') {
                    new Notification(title, { body });
                }
            }

            function checkRemindersForNotification() {
                const now = new Date();
                reminders.forEach(reminder => {
                    const dueDate = new Date(reminder.dueDate);
                    // Check if reminder is due within the next minute and not yet notified
                    if (!reminder.notified && !reminder.completed && dueDate <= now && dueDate > new Date(now.getTime() - 60000)) {
                        showNotification('Reminder!', reminder.text);
                        reminder.notified = true; // Mark as notified
                        saveReminders(); // Save the updated status
                    }
                });
            }

            function formatDueDate(dateString) {
                if (!dateString) return '';
                const date = new Date(dateString);
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const tomorrow = new Date(today);
                tomorrow.setDate(tomorrow.getDate() + 1);

                let datePart;
                const dateToCompare = new Date(date.getFullYear(), date.getMonth(), date.getDate());

                if (dateToCompare.getTime() === today.getTime()) {
                    datePart = 'Today';
                } else if (dateToCompare.getTime() === tomorrow.getTime()) {
                    datePart = 'Tomorrow';
                } else {
                    datePart = date.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
                }

                const timePart = date.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit', hour12: true });
                return `${datePart} at ${timePart}`;
            }

            function renderReminders() {
                if (!remindersListEl) return;
                remindersListEl.innerHTML = '';

                if (reminders.length === 0) {
                    const emptyLi = document.createElement('li');
                    emptyLi.textContent = 'No reminders yet. Add one below!';
                    emptyLi.style.cssText = 'text-align: center; color: var(--text-light); border-bottom: none; padding: 10px 0;';
                    remindersListEl.appendChild(emptyLi);
                    return;
                }

                reminders.forEach(reminder => {
                    const li = document.createElement('li');
                    li.dataset.id = reminder.id;

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.classList.add('reminder-checkbox');
                    checkbox.checked = reminder.completed;
                    checkbox.addEventListener('change', () => toggleReminderComplete(reminder.id));

                    const detailsDiv = document.createElement('div');
                    detailsDiv.className = 'reminder-details';

                    const textSpan = document.createElement('div');
                    textSpan.classList.add('reminder-text');
                    textSpan.textContent = reminder.text;
                    if (reminder.completed) {
                        textSpan.classList.add('completed');
                    }

                    const dateSpan = document.createElement('div');
                    dateSpan.className = 'reminder-date';
                    dateSpan.textContent = formatDueDate(reminder.dueDate);

                    detailsDiv.appendChild(textSpan);
                    detailsDiv.appendChild(dateSpan);

                    const deleteBtn = document.createElement('button');
                    deleteBtn.classList.add('delete-reminder-btn');
                    deleteBtn.innerHTML = '&times;';
                    deleteBtn.title = "Delete Reminder";
                    deleteBtn.addEventListener('click', () => deleteReminder(reminder.id));

                    li.appendChild(checkbox);
                    li.appendChild(detailsDiv);
                    li.appendChild(deleteBtn);
                    remindersListEl.appendChild(li);
                });
            }

            function openCalendarModal() {
                reminderTextToSet = newReminderInput.value.trim();
                if (reminderTextToSet === '') {
                    alert("Please type a reminder message first!");
                    newReminderInput.focus();
                    return;
                }

                selectedDate = new Date();
                const now = new Date();
                const hours = now.getHours().toString().padStart(2, '0');
                const minutes = now.getMinutes().toString().padStart(2, '0');
                reminderTimeInput.value = `${hours}:${minutes}`;

                generateCalendar();
                reminderCalendarModal.classList.remove('fade-out');
                reminderCalendarModal.style.display = 'flex';
            }

            function closeCalendarModal() {
                reminderCalendarModal.classList.add('fade-out');
                setTimeout(() => {
                    reminderCalendarModal.style.display = 'none';
                }, 400);
            }

            function generateCalendar() {
                calendarGridEl.innerHTML = '';
                const month = calendarDate.getMonth();
                const year = calendarDate.getFullYear();

                calendarMonthYearEl.textContent = `${calendarDate.toLocaleString('default', { month: 'long' })} ${year}`;

                const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                dayNames.forEach(day => {
                    const dayNameEl = document.createElement('div');
                    dayNameEl.classList.add('calendar-day-name');
                    dayNameEl.textContent = day;
                    calendarGridEl.appendChild(dayNameEl);
                });

                const firstDayOfMonth = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();

                const reminderDates = reminders.map(r => {
                    const d = new Date(r.dueDate);
                    return `${d.getFullYear()}-${d.getMonth()}-${d.getDate()}`;
                });

                for (let i = 0; i < firstDayOfMonth; i++) {
                    calendarGridEl.appendChild(document.createElement('div'));
                }

                for (let i = 1; i <= daysInMonth; i++) {
                    const dayEl = document.createElement('div');
                    dayEl.classList.add('calendar-day');
                    dayEl.textContent = i;
                    dayEl.dataset.date = new Date(year, month, i);

                    const today = new Date();
                    if (i === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                        dayEl.classList.add('today');
                    }
                    if (selectedDate && i === selectedDate.getDate() && month === selectedDate.getMonth() && year === selectedDate.getFullYear()) {
                        dayEl.classList.add('selected');
                    }
                    if (reminderDates.includes(`${year}-${month}-${i}`)) {
                        const dot = document.createElement('div');
                        dot.className = 'reminder-dot';
                        dayEl.appendChild(dot);
                    }

                    dayEl.addEventListener('click', () => {
                        selectedDate = new Date(year, month, i);
                        document.querySelectorAll('.calendar-day.selected').forEach(d => d.classList.remove('selected'));
                        dayEl.classList.add('selected');
                    });
                    calendarGridEl.appendChild(dayEl);
                }
            }

            prevMonthBtn.addEventListener('click', () => {
                calendarDate.setMonth(calendarDate.getMonth() - 1);
                generateCalendar();
            });
            nextMonthBtn.addEventListener('click', () => {
                calendarDate.setMonth(calendarDate.getMonth() + 1);
                generateCalendar();
            });

            function confirmAndSetReminder() {
                requestNotificationPermission(); // Ask for permission when user sets a reminder

                if (!selectedDate || !reminderTextToSet) return;

                const timeParts = reminderTimeInput.value.split(':');
                selectedDate.setHours(parseInt(timeParts[0] || 0));
                selectedDate.setMinutes(parseInt(timeParts[1] || 0));
                selectedDate.setSeconds(0);

                const newReminder = {
                    id: `rem-${Date.now()}`,
                    text: reminderTextToSet,
                    completed: false,
                    dueDate: selectedDate.toISOString(),
                    notified: false // NEW: Add notified flag
                };
                reminders.push(newReminder);
                saveReminders();
                renderReminders();
                newReminderInput.value = '';
                closeCalendarModal();
            }

            setReminderBtn.addEventListener('click', confirmAndSetReminder);
            cancelReminderBtn.addEventListener('click', closeCalendarModal);

            function deleteReminder(reminderId) {
                reminders = reminders.filter(r => r.id !== reminderId);
                saveReminders();
                renderReminders();
            }

            function toggleReminderComplete(reminderId) {
                const reminder = reminders.find(r => r.id === reminderId);
                if (reminder) {
                    reminder.completed = !reminder.completed;
                    saveReminders();
                    renderReminders();
                }
            }

            addReminderBtn.addEventListener('click', openCalendarModal);
            newReminderInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    openCalendarModal();
                }
            });


            // --- ENHANCED MOOD TRACKER ---
            const moodEmojiTriggers = document.querySelectorAll('.mood-emoji-trigger');
            const moodLoggingModal = document.getElementById('moodLoggingModal');
            const modalSelectedMoodEmoji = document.getElementById('modalSelectedMoodEmoji');
            const moodNoteInput = document.getElementById('moodNoteInput');
            const saveMoodLogBtn = document.getElementById('saveMoodLogBtn');
            const cancelMoodLogBtn = document.getElementById('cancelMoodLogBtn');

            const moodLogListSummaryEl = document.getElementById('moodLogListSummary');

            const viewMoodLogTabBtn = document.getElementById('viewMoodLogTabBtn');
            const fullMoodLogViewModal = document.getElementById('fullMoodLogViewModal');
            const closeFullLogViewBtn = document.getElementById('closeFullLogViewBtn');
            const fullLogListContainer = document.getElementById('fullLogListContainer');
            const summaryMoodLogTabBtn = document.getElementById('summaryMoodLogTabBtn');

            let currentSelectedMood = { type: '', emoji: ''};

            function openMoodModal(moodType, moodEmoji) {
                currentSelectedMood.type = moodType;
                currentSelectedMood.emoji = moodEmoji;
                if(modalSelectedMoodEmoji) modalSelectedMoodEmoji.textContent = moodEmoji;
                if(moodNoteInput) moodNoteInput.value = '';
                if(moodLoggingModal) {
                    moodLoggingModal.classList.remove('fade-out');
                    moodLoggingModal.style.display = 'flex';
                }
                if(moodNoteInput) moodNoteInput.focus();
            }

            function closeMoodModal() {
                if(moodLoggingModal) {
                    moodLoggingModal.classList.add('fade-out');
                    setTimeout(() => {
                        moodLoggingModal.style.display = 'none';
                    }, 400);
                }
            }

            if (moodEmojiTriggers) {
                moodEmojiTriggers.forEach(trigger => {
                    trigger.addEventListener('click', function() {
                        openMoodModal(this.dataset.mood, this.dataset.emoji);
                    });
                });
            }

            if (saveMoodLogBtn) {
                saveMoodLogBtn.addEventListener('click', () => {
                    const note = moodNoteInput.value.trim();
                    const timestamp = new Date();
                    const moodEntry = {
                        mood: currentSelectedMood.type, emoji: currentSelectedMood.emoji,
                        note: note, timestamp: timestamp.toISOString()
                    };
                    saveMoodEntry(moodEntry);
                    renderMoodLogSummary();
                    if (fullMoodLogViewModal && fullMoodLogViewModal.style.display === 'flex') {
                        renderFullMoodLog();
                    }
                    closeMoodModal();
                });
            }

            if(cancelMoodLogBtn) cancelMoodLogBtn.addEventListener('click', closeMoodModal);

            function getMoodLog() {
                return JSON.parse(localStorage.getItem('moodLog') || '[]');
            }
            function saveMoodEntry(entry) {
                const log = getMoodLog();
                log.unshift(entry); // Add to the beginning to show most recent first
                localStorage.setItem('moodLog', JSON.stringify(log));
            }

            function renderMoodLogSummary() {
                const log = getMoodLog();
                if (!moodLogListSummaryEl) return;
                moodLogListSummaryEl.innerHTML = '';
                if (log.length === 0) {
                    moodLogListSummaryEl.innerHTML = '<p class="empty-log-message">No moods logged yet. Click an emoji below to start!</p>';
                    return;
                }
                const summaryLog = log.slice(0, 5); // Show only top 5 for summary
                summaryLog.forEach(entry => {
                    const li = document.createElement('li');
                    const entryDate = new Date(entry.timestamp);
                    const formattedTimestamp = entryDate.toLocaleString(undefined, {
                        month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
                    });
                    li.innerHTML = `
                        <span class="log-emoji">${entry.emoji}</span>
                        <div class="log-details">
                            <p class="log-note">${(entry.note ? entry.note.substring(0, 50) + (entry.note.length > 50 ? '...' : '') : '<em>No note</em>')}</p>
                            <p class="log-timestamp">${formattedTimestamp}</p>
                        </div>`;
                    moodLogListSummaryEl.appendChild(li);
                });
            }

            function renderFullMoodLog() {
                const log = getMoodLog();
                if (!fullLogListContainer) return;
                fullLogListContainer.innerHTML = '';
                if (log.length === 0) {
                    fullLogListContainer.innerHTML = '<p class="empty-full-log-message">Your mood log is empty. Start logging your mood using the emojis below!</p>';
                    return;
                }
                log.forEach(entry => {
                    const li = document.createElement('li');
                    const entryDate = new Date(entry.timestamp);
                    const formattedTimestamp = entryDate.toLocaleString(undefined, {
                        year: 'numeric', month: 'long', day: 'numeric',
                        hour: '2-digit', minute: '2-digit', second: '2-digit'
                    });
                    li.innerHTML = `
                        <span class="log-emoji">${entry.emoji}</span>
                        <div class="log-details">
                            <p class="log-note">${entry.note || '<em>No note added for this entry.</em>'}</p>
                            <p class="log-timestamp">Logged on: ${formattedTimestamp}</p>
                        </div>`;
                    fullLogListContainer.appendChild(li);
                });
            }

            if (viewMoodLogTabBtn) {
                viewMoodLogTabBtn.addEventListener('click', () => {
                    viewMoodLogTabBtn.classList.add('active');
                    summaryMoodLogTabBtn.classList.remove('active');
                    renderFullMoodLog();
                    if(fullMoodLogViewModal) {
                           fullMoodLogViewModal.classList.remove('fade-out');
                           fullMoodLogViewModal.style.display = 'flex';
                    }
                });
            }

            if (summaryMoodLogTabBtn) {
                summaryMoodLogTabBtn.addEventListener('click', () => {
                    summaryMoodLogTabBtn.classList.add('active');
                    viewMoodLogTabBtn.classList.remove('active');
                    // Summary is already rendered, just close full view if open
                    closeFullLogViewModal();
                });
            }


            function closeFullLogViewModal() {
                 if(fullMoodLogViewModal) {
                    fullMoodLogViewModal.classList.add('fade-out');
                    setTimeout(() => {
                        fullMoodLogViewModal.style.display = 'none';
                    }, 400);
                 }
            }

            if(closeFullLogViewBtn) closeFullLogViewBtn.addEventListener('click', closeFullLogViewModal);

            // Close modal when clicking on the overlay
            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.addEventListener('click', (event) => {
                    if (event.target === modal) {
                        // Check which modal it is and call its specific close function
                        if(modal.id === 'fullMoodLogViewModal') closeFullLogViewModal();
                        if(modal.id === 'moodLoggingModal') closeMoodModal();
                        if(modal.id === 'reminderCalendarModal') closeCalendarModal();
                        if(modal.id === 'taskDueDateModal') closeTaskDateModal(); // Added for task date modal
                    }
                });
            });

            renderMoodLogSummary(); // Initial render of summary

            // --- ZODIAC PREDICTION ---
            const zodiacLink = document.getElementById('zodiacLink');
            const zodiacPredictionText = document.getElementById('zodiacPredictionText');
            const zodiacPredictions = [
                "Today is a good day for learning new things and expanding your horizons.",
                "Expect a pleasant surprise from an unexpected source!",
                "Focus on your most important tasks; efficiency will lead to success.",
                "Connect with loved ones. Emotional bonds will be strengthened today.",
                "A creative idea will spark; don't be afraid to pursue it.",
                "Take a moment for self-reflection. Inner peace will bring clarity.",
                "New opportunities may arise. Be open to change and growth.",
                "It's a great day for collaboration. Teamwork will lead to breakthroughs.",
                "Financial matters may require your attention. Review your budget.",
                "Embrace spontaneity! A delightful adventure awaits.",
                "Your intuition is strong today. Trust your gut feelings.",
                "Practice gratitude. A positive mindset will attract positive outcomes."
            ];
            if(zodiacLink && zodiacPredictionText) {
                zodiacLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    zodiacPredictionText.textContent = zodiacPredictions[Math.floor(Math.random() * zodiacPredictions.length)];
                });
            }

            // --- CONFETTI FUNCTION ---
            const confettiContainer = document.getElementById('confetti-container');
            function triggerConfetti() {
                if (!confettiContainer) return;
                confettiContainer.innerHTML = '';
                for (let i = 0; i < 50; i++) {
                    const piece = document.createElement('div');
                    piece.classList.add('confetti-piece');
                    piece.style.left = `${Math.random() * window.innerWidth}px`;
                    piece.style.top = `${-20 - (Math.random() * 50)}px`;
                    const colors = ['#FFC107', '#4CAF50', '#2196F3', '#E91E63', '#9C27B0', '#FFEB3B'];
                    piece.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    piece.style.width = (Math.random() * 6 + 4) + 'px';
                    piece.style.height = (Math.random() * 10 + 6) + 'px';
                    if(Math.random() > 0.5) piece.style.borderRadius = '50%';
                    piece.style.animationDuration = (Math.random() * 1 + 2) + 's';
                    piece.style.animationDelay = (Math.random() * 0.2) + 's';
                    confettiContainer.appendChild(piece);
                    setTimeout(() => piece.remove(), parseFloat(piece.style.animationDuration) * 1000 + parseFloat(piece.style.animationDelay) * 1000 + 100);
                }
            }

            // --- SEARCH FUNCTIONALITY ---
            const searchInput = document.getElementById('searchInput');
            const searchButton = document.getElementById('searchButton');
            if (searchInput && searchButton) {
                searchInput.addEventListener('keypress', e => { if (e.key === 'Enter') searchButton.click(); });
                searchButton.addEventListener('click', () => {
                    const searchTerm = searchInput.value;
                    alert(searchTerm ? `Searching for: ${searchTerm}... (Not implemented)` : 'Please enter a search term.');
                });
            }

            // --- INITIALIZE TIMERS AND CHECKS ---
            loadReminders(); // Load existing reminders
            loadTodoCards(); // Load existing todo cards
            setInterval(checkRemindersForNotification, 60000); // Check every minute
            checkRemindersForNotification(); // Also check once on page load

            // Update task due dates on load and periodically
            function refreshAllTaskDueDates() {
                document.querySelectorAll('.todo-card .task-due-date').forEach(dueDateSpan => {
                    const checkbox = dueDateSpan.closest('li').querySelector('input[type="checkbox"]');
                    updateTaskDueDateDisplay(dueDateSpan, checkbox.checked);
                });
            }
            setInterval(refreshAllTaskDueDates, 5 * 60 * 1000); // Refresh every 5 minutes for "overdue" status
            refreshAllTaskDueDates(); // Initial refresh
        });
    </script>
</body>
</html>
