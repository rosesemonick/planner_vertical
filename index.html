<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Wellness Planner</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* CSS Custom Properties for Theming */
        :root {
            --accent-color-light: #6C63FF;
            --accent-color-translucent-light: rgba(108, 99, 255, 0.15);
            --new-todo-btn-shadow-light: 0 4px 15px rgba(108, 99, 255, 0.3);
            --new-todo-btn-hover-shadow-light: 0 6px 20px rgba(108, 99, 255, 0.4);
            --bg-image-light: linear-gradient(120deg, #eacdd7 0%, #cdd6e8 100%);
            --widget-bg-light: rgba(255, 255, 255, 0.45);
            --widget-border-light: rgba(255, 255, 255, 0.7);
            --header-bg-light: rgba(255, 255, 255, 0.35);
            --sidebar-bg-light: rgba(255, 255, 255, 0.25);
            --text-color-light: #2c3e50;
            --text-light-light: #576574;
            --shadow-light: 0 8px 32px 0 rgba(108, 99, 255, 0.1);
            --sidebar-shadow-light: 3px 0px 25px -5px rgba(108, 99, 255, 0.15);
            --header-shadow-light: 0 3px 25px -5px rgba(108, 99, 255, 0.15);
            --danger-color-light: #e74c3c;
            
            --bg-image: var(--bg-image-light);
            --widget-bg: var(--widget-bg-light);
            --widget-border-color: var(--widget-border-light);
            --header-bg: var(--header-bg-light);
            --sidebar-bg: var(--sidebar-bg-light);
            --text-color: var(--text-color-light);
            --text-light: var(--text-light-light);
            --accent-color: var(--accent-color-light);
            --accent-color-translucent: var(--accent-color-translucent-light);
            --nav-link-color: var(--text-color-light);
            --nav-link-hover-bg: rgba(255, 255, 255, 0.2);
            --progress-bar-bg: rgba(44, 62, 80, 0.1);
            --progress-bar-fill-1: #8f8aff;
            --progress-bar-fill-2: var(--accent-color-light);
            --progress-bar-fill-complete: #2ecc71;
            --icon-color: var(--text-color-light);
            --button-bg: rgba(255, 255, 255, 0.3);
            --button-text: var(--text-color-light);
            --box-shadow: var(--shadow-light);
            --sidebar-shadow: var(--sidebar-shadow-light);
            --header-shadow: var(--header-shadow-light);
            --modal-overlay-bg: rgba(0, 0, 0, 0.4);
            --input-bg: rgba(255, 255, 255, 0.2);
            --danger-color: var(--danger-color-light);
            --danger-color-hover: #c0392b;
            --warning-color: #f1c40f;
            --new-todo-btn-bg: var(--accent-color-light);
            --new-todo-btn-text: #ffffff;
            --new-todo-btn-shadow: var(--new-todo-btn-shadow-light);
            --new-todo-btn-hover-shadow: var(--new-todo-btn-hover-shadow-light);
        }

        body.dark-mode {
            --accent-color-dark: #8B84FF;
            --accent-color-translucent-dark: rgba(139, 132, 255, 0.15);
            --new-todo-btn-shadow-dark: 0 4px 15px rgba(139, 132, 255, 0.2);
            --new-todo-btn-hover-shadow-dark: 0 6px 20px rgba(139, 132, 255, 0.3);
            --bg-image-dark: linear-gradient(120deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
            --widget-bg-dark: rgba(20, 25, 30, 0.45);
            --widget-border-dark: rgba(255, 255, 255, 0.15);
            --header-bg-dark: rgba(20, 25, 30, 0.35);
            --sidebar-bg-dark: rgba(20, 25, 30, 0.25);
            --text-color-dark: #ecf0f1;
            --text-light-dark: #bdc3c7;
            --shadow-dark: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
            --sidebar-shadow-dark: 3px 0px 25px -5px rgba(0, 0, 0, 0.25);
            --header-shadow-dark: 0 3px 25px -5px rgba(0, 0, 0, 0.25);
            --danger-color-dark: #e74c3c;

            --bg-image: var(--bg-image-dark);
            --widget-bg: var(--widget-bg-dark);
            --widget-border-color: var(--widget-border-dark);
            --header-bg: var(--header-bg-dark);
            --sidebar-bg: var(--sidebar-bg-dark);
            --text-color: var(--text-color-dark);
            --text-light: var(--text-light-dark);
            --accent-color: var(--accent-color-dark);
            --accent-color-translucent: var(--accent-color-translucent-dark);
            --nav-link-color: var(--text-color-dark);
            --nav-link-hover-bg: rgba(0, 0, 0, 0.2);
            --progress-bar-bg: rgba(236, 240, 241, 0.1);
            --progress-bar-fill-1: #a099ff;
            --progress-bar-fill-2: var(--accent-color-dark);
            --progress-bar-fill-complete: #27ae60;
            --icon-color: var(--text-color-dark);
            --button-bg: rgba(0, 0, 0, 0.2);
            --button-text: var(--text-color-dark);
            --box-shadow: var(--shadow-dark);
            --sidebar-shadow: var(--sidebar-shadow-dark);
            --header-shadow: var(--header-shadow-dark);
            --modal-overlay-bg: rgba(0, 0, 0, 0.5);
            --input-bg: rgba(0, 0, 0, 0.15);
            --danger-color: var(--danger-color-dark);
            --danger-color-hover: #c0392b;
            --warning-color: #f39c12;
            --new-todo-btn-bg: var(--accent-color-dark);
            --new-todo-btn-shadow: var(--new-todo-btn-shadow-dark);
            --new-todo-btn-hover-shadow: var(--new-todo-btn-hover-shadow-dark);
        }

        /* Basic Reset */
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Poppins', 'Segoe UI', 'Roboto', sans-serif;
            background-image: var(--bg-image);
            color: var(--text-color);
            transition: background-image 0.5s, color 0.5s;
            background-attachment: fixed;
            padding-top: 80px;
            padding-left: 240px;
        }

        .glass {
            background: var(--widget-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--widget-border-color);
            box-shadow: var(--box-shadow);
            border-radius: 16px;
            transition: background 0.3s, border 0.3s, box-shadow 0.3s;
        }
        
        /* Header */
        header {
            padding: 0 10px 0 20px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: fixed;
            top: 10px;
            right: 10px;
            left: 240px;
            z-index: 1000;
            background: var(--header-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            box-shadow: var(--header-shadow);
            border-radius: 16px;
            border: 1px solid var(--widget-border-color);
        }

        .logo {
            width: 45px;
            height: 45px;
            position: relative;
        }
        .logo img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 2px solid var(--widget-border-color);
            object-fit: cover;
            cursor: pointer;
            background-color: white;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .logo img:hover {
            transform: scale(1.08);
            box-shadow: 0 0 12px var(--accent-color-translucent);
        }
        .logo input[type="file"] {
            display: none;
        }

        .delete-avatar-btn {
            position: absolute;
            top: -5px; right: -5px;
            width: 24px; height: 24px;
            background-color: var(--danger-color);
            color: white;
            border: 2px solid var(--widget-bg);
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.1em;
            line-height: 20px;
            text-align: center;
            opacity: 0;
            transform: scale(0.8);
            transition: opacity 0.2s, transform 0.2s;
            z-index: 10;
        }
        .logo:hover .delete-avatar-btn {
            opacity: 1;
            transform: scale(1);
        }
        .delete-avatar-btn:hover {
            background-color: var(--danger-color-hover);
            transform: scale(1.1);
        }
        header nav {
            margin: 0 20px;
            flex-grow: 1;
        }
        header nav a {
            color: var(--nav-link-color);
            text-decoration: none;
            margin: 0 10px;
            font-weight: 500;
            padding: 8px 12px;
            border-radius: 10px;
            font-size: 0.9em;
            transition: background-color 0.3s, color 0.3s;
        }
        header nav a:hover {
            background-color: var(--nav-link-hover-bg);
            color: var(--accent-color);
        }
        .search-bar {
            display: flex;
            align-items: center;
            background: var(--widget-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--widget-border-color);
            box-shadow: var(--box-shadow);
            border-radius: 25px;
            padding: 0 0 0 15px;
            height: 42px;
            flex-shrink: 1;
            min-width: 200px;
        }
        .search-bar input[type="search"] {
            flex-grow: 1;
            background: transparent;
            border: none;
            outline: none;
            color: var(--text-color);
            height: 100%;
            font-size: 0.9em;
            font-family: 'Poppins', sans-serif;
        }
        .search-bar input[type="search"]::placeholder {
            color: var(--text-light);
            opacity: 0.8;
        }
        .search-bar button {
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: none;
            border-left: 1px solid var(--widget-border-color);
            color: var(--accent-color);
            height: 60%;
            padding: 0 12px;
            margin: 0 5px;
            cursor: pointer;
            font-size: 1.2em;
        }
        
        /* Left Sidebar */
        .left-sidebar {
            position: fixed;
            top: 10px; left: 10px;
            width: 220px;
            height: calc(100vh - 20px);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            z-index: 1001;
            background: var(--sidebar-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--widget-border-color);
            box-shadow: var(--sidebar-shadow);
            border-radius: 16px;
        }

        #newPageBtn {
            padding: 12px;
            background: var(--new-todo-btn-bg);
            color: var(--new-todo-btn-text);
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1em;
            text-align: center;
            width: 100%;
            box-shadow: var(--new-todo-btn-shadow);
            transition: background-color 0.2s, transform 0.2s, box-shadow 0.2s;
        }
        #newPageBtn:hover, #newPageBtn:focus {
            transform: translateY(-3px) scale(1.02);
            box-shadow: var(--new-todo-btn-hover-shadow);
            outline: none;
        }

        .sidebar-tab-button {
            padding: 10px 12px;
            background: var(--button-bg);
            color: var(--text-color);
            border: 1px solid transparent;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 500;
            text-align: left;
            transition: background 0.3s, border 0.3s, transform 0.2s;
            width: 100%;
            display: flex;
            align-items: center;
            font-size: 0.9em;
        }
        .sidebar-tab-button:hover {
            background: var(--widget-bg);
            border-color: var(--widget-border-color);
            transform: translateX(5px);
        }
        .sidebar-tab-button .tab-icon {
            margin-right: 12px;
            font-size: 1.2em;
            color: var(--accent-color);
        }
        
        /* Sidebar bottom controls */
        #sidebarStreakBtn {
            margin-top: auto;
        }
        .mood-tracker-launcher {
            width: 100%;
            box-sizing: border-box;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px;
            padding: 12px 8px;
            background: var(--button-bg);
            border-radius: 12px;
        }
        .mood-emoji-trigger {
            font-size: 1.8em;
            cursor: pointer;
            transition: transform 0.2s ease-in-out, filter 0.2s;
            opacity: 0.7;
        }
        .mood-emoji-trigger:hover {
            transform: scale(1.25);
            opacity: 1;
            filter: saturate(1.5);
        }
        
        .sidebar-weather {
            background: var(--button-bg);
            border-radius: 12px;
            padding: 12px;
        }
        .sidebar-weather .weather-header {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .sidebar-weather #weatherIcon { font-size: 2.2em; }
        .sidebar-weather .weather-details { display: flex; flex-direction: column; }
        .sidebar-weather #weatherTemp { font-size: 1.3em; font-weight: 600; }
        .sidebar-weather #weatherCity { font-size: 0.8em; color: var(--text-light); }
        .sidebar-weather #weatherDesc {
            font-size: 0.8em;
            margin-top: 8px;
            text-align: center;
            color: var(--text-light);
        }
        
        /* Main Content Area */
        .main-content {
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .motivational-quote-banner {
            padding: 15px 25px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            background: var(--widget-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--widget-border-color);
            box-shadow: var(--box-shadow);
            border-radius: 16px;
        }
        #motivationalQuoteP {
            font-style: italic;
            color: var(--text-light);
            flex-grow: 1;
            text-align: center;
            font-size: 1em;
            font-weight: 300;
        }
        #streakDisplay {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.3em;
            font-weight: 600;
            color: var(--accent-color);
            background: var(--widget-bg);
            padding: 8px 15px;
            border-radius: 25px;
            cursor: default;
            width: fit-content;
            margin: 0 auto;
            border: 1px solid var(--widget-border-color);
        }
        #streakDisplay .fire-icon {
            font-size: 1.4em;
            animation: flicker 1.5s ease-in-out infinite;
        }
        @keyframes flicker {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }

        .widgets-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 0;
            background: var(--widget-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 16px;
            border: 1px solid var(--widget-border-color);
            overflow: hidden;
            box-shadow: var(--box-shadow);
        }
        
        .widget {
            padding: 20px;
            display: flex;
            flex-direction: column;
            transition: transform 0.2s ease;
        }
        .widget:hover {
            transform: translateY(-2px) scale(1.01);
            z-index: 10;
        }
        .widgets-container > .widget {
            border-bottom: 1px solid var(--widget-border-color);
            border-right: 1px solid var(--widget-border-color);
        }
        
        /* Drag and Drop Styles */
        .drag-handle { cursor: grab; }
        .drag-handle:active { cursor: grabbing; }
        .sortable-ghost {
            opacity: 0.4;
            background: var(--accent-color-translucent);
            border: 2px dashed var(--accent-color);
        }
        
        /* Widget Headers */
        .widget h2 {
            margin-bottom: 15px;
            font-size: 1.4em;
            color: var(--text-color);
            font-weight: 600;
        }
        .widget .widget-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .widget .widget-header h2 {
            margin-bottom: 0;
            flex-grow: 1;
            margin-right: 10px;
        }
        .widget .close-btn {
            background: none; border: none;
            font-size: 1.8em;
            cursor: pointer;
            color: var(--icon-color);
            padding: 0 5px;
            line-height: 1;
            opacity: 0.6;
            transition: opacity 0.2s, transform 0.2s;
        }
        .widget .close-btn:hover {
            opacity: 1;
            transform: scale(1.2) rotate(90deg);
        }
        
        /* Reminders Widget */
        .reminders-widget ul#remindersList {
            list-style: none;
            padding: 0;
            margin-bottom: 15px;
            max-height: 250px;
            overflow-y: auto;
            padding-right: 5px;
        }
        .reminders-widget li {
            padding: 10px;
            border-bottom: 1px solid var(--widget-border-color);
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background-color 0.2s, opacity 0.4s ease;
            border-radius: 8px;
        }
        .reminders-widget li:hover { background-color: var(--accent-color-translucent); }
        .reminders-widget li:last-child { border-bottom: none; }
        .reminders-widget .reminder-checkbox {
            accent-color: var(--accent-color);
            width: 18px; height: 18px;
            flex-shrink: 0;
            cursor: pointer;
        }
        .reminders-widget .reminder-details { flex-grow: 1; }
        .reminders-widget .reminder-text {
            color: var(--text-color);
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 0.95em;
        }
        .reminders-widget .reminder-date {
            font-size: 0.8em;
            color: var(--accent-color);
            font-weight: 500;
            margin-top: 4px;
        }
        .reminders-widget .delete-reminder-btn {
            background: none; border: none;
            color: var(--danger-color);
            font-size: 1.3em;
            font-weight: bold;
            cursor: pointer;
            padding: 0 5px;
            line-height: 1;
            border-radius: 50%;
            transition: color 0.2s, background-color 0.2s, transform 0.2s;
            flex-shrink: 0;
        }
        .reminders-widget .delete-reminder-btn:hover {
            color: white;
            background-color: var(--danger-color-hover);
            transform: scale(1.1);
        }
        .add-reminder-form {
            display: flex;
            gap: 10px;
            margin-top: auto;
            border-top: 1px solid var(--widget-border-color);
            padding-top: 15px;
        }
        .add-reminder-form #newReminderInput {
            flex-grow: 1; padding: 8px 12px;
            border: 1px solid var(--widget-border-color);
            border-radius: 8px;
            background-color: var(--input-bg);
            color: var(--text-color);
            font-size: 0.9em;
            outline: none;
            transition: box-shadow 0.2s;
            font-family: 'Poppins', sans-serif;
        }
        .add-reminder-form #newReminderInput:focus { box-shadow: 0 0 0 3px var(--accent-color-translucent); }
        .add-reminder-form #newReminderInput::placeholder { color: var(--text-light); opacity: 0.8; }
        .add-reminder-form #addReminderBtn {
            padding: 8px 15px;
            background-color: var(--accent-color);
            color: white; border: none;
            border-radius: 8px; cursor: pointer;
            font-weight: bold; font-size: 1em;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .add-reminder-form #addReminderBtn:hover {
            transform: scale(1.05);
            box-shadow: var(--new-todo-btn-shadow);
        }
        
        /* TODO Card Widget */
        .todo-card ul.task-list {
            list-style: none;
            padding: 0;
            margin-bottom: 15px;
            padding-left: 5px;
        }
        .reminders-widget li, .todo-card li { transition: opacity 0.4s ease; }
        .todo-card ul.task-list li {
            padding: 8px 5px; display: flex;
            flex-wrap: wrap; align-items: center;
            gap: 5px 10px;
            border-bottom: 1px solid var(--widget-border-color);
            transition: opacity 0.4s ease, background-color 0.2s;
            border-radius: 8px;
        }
        .todo-card ul.task-list li:hover { background-color: var(--accent-color-translucent); }
        .todo-card ul.task-list li:last-child { border-bottom: none; }
        .todo-card input[type="checkbox"] {
            margin-right: 5px;
            accent-color: var(--accent-color);
            width: 18px; height: 18px;
            flex-shrink: 0; cursor: pointer;
        }
        .todo-card .task-content {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            min-width: 0;
        }
        .todo-card .task-label {
            color: var(--text-color);
            word-break: break-word;
            cursor: pointer;
            font-size: 0.95em;
        }
        .todo-card .task-label.overdue { color: var(--danger-color); font-weight: 600; }
        .todo-card .task-label.completed {
            text-decoration: line-through;
            color: var(--text-light);
            opacity: 0.7;
        }
        .todo-card .task-due-date-input {
            margin-top: 4px; padding: 2px 4px;
            border: 1px solid transparent; border-radius: 6px;
            font-size: 0.75em; color: var(--text-light);
            background-color: transparent;
            cursor: pointer; width: fit-content;
            transition: border 0.2s, color 0.2s;
        }
        .todo-card .task-due-date-input:hover {
            border-color: var(--widget-border-color);
            color: var(--accent-color);
        }
        .todo-card .delete-task-btn {
            background: none; border: none;
            color: var(--danger-color);
            font-size: 1.3em; font-weight: bold;
            cursor: pointer; padding: 0 5px;
            line-height: 1; border-radius: 50%;
            transition: color 0.2s, background-color 0.2s, transform 0.2s;
            flex-shrink: 0; margin-left: auto; opacity: 0.6;
        }
        .todo-card .delete-task-btn:hover {
            opacity: 1; color: white;
            background-color: var(--danger-color-hover);
            transform: scale(1.1);
        }
        .progress-item {
            margin-top: auto;
            padding-top: 15px;
            border-top: 1px solid var(--widget-border-color);
        }
        .progress-bar-container {
            width: 100%;
            background-color: var(--progress-bar-bg);
            border-radius: 10px;
            height: 10px;
            overflow: hidden;
            margin-bottom: 8px;
        }
        .progress-bar {
            height: 100%;
            background-color: var(--progress-bar-fill-1);
            border-radius: 10px;
            transition: width 0.5s ease-in-out, background-color 0.5s ease;
            text-align: center;
            color: white;
            font-size: 0;
            line-height: 10px;
        }
        .progress-label {
            font-size: 0.85em;
            color: var(--text-light);
            text-align: center;
            font-weight: 500;
        }
        .add-task-btn {
            background-color: var(--accent-color-translucent);
            color: var(--accent-color);
            border: 1px solid transparent;
            padding: 6px 12px;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 10px; margin-bottom: 5px;
            display: block; width: fit-content;
            margin-left: auto; margin-right: auto;
            transition: background-color 0.2s, color 0.2s, transform 0.2s;
            font-weight: 500; font-size: 0.9em;
        }
        .add-task-btn:hover {
            background-color: var(--accent-color);
            color: white;
            transform: scale(1.05);
        }
        
        /* Horoscope Section */
        .horoscope-section {
            text-align: center;
            padding: 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        .horoscope-header {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .horoscope-icon { font-size: 3em; line-height: 1; }
        .horoscope-header h3 {
            font-size: 1.8em;
            margin: 0;
            color: var(--text-color);
            font-weight: 600;
        }
        #getHoroscopeBtn {
            padding: 10px 22px;
            background-color: var(--accent-color);
            color: white; border: none;
            border-radius: 25px;
            cursor: pointer; font-weight: 500;
            font-size: 0.9em;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 10px rgba(108, 99, 255, 0.2);
        }
        #getHoroscopeBtn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 15px rgba(108, 99, 255, 0.4);
        }

        /* Calendar Widget */
        .calendar-widget {
            --cal-day-hover-bg: var(--accent-color-translucent);
            --cal-today-border: 2px solid var(--accent-color);
            --cal-event-dot-incomplete: var(--danger-color);
            --cal-event-dot-partial: var(--warning-color);
            --cal-event-dot-complete: var(--progress-bar-fill-complete);
        }
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .calendar-header h3 { margin: 0; font-size: 1.1em; font-weight: 600; }
        .calendar-nav-btn {
            background: none; border: none;
            font-size: 1.6em; color: var(--icon-color);
            cursor: pointer; padding: 0 8px;
            border-radius: 50%;
            transition: background-color 0.2s, transform 0.2s;
        }
        .calendar-nav-btn:hover {
            background-color: var(--button-bg);
            transform: scale(1.1);
        }
        .calendar-grid-widget {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }
        .cal-day-name, .cal-day {
            text-align: center; padding: 4px;
            font-size: 0.8em; font-weight: 500;
            color: var(--text-light);
            aspect-ratio: 1 / 1;
            display: flex; justify-content: center; align-items: center;
        }
        .cal-day {
            cursor: pointer; border-radius: 50%;
            position: relative;
            transition: background-color 0.2s, color 0.2s, transform 0.1s ease-out;
            color: var(--text-color);
        }
        .cal-day:hover {
            background-color: var(--cal-day-hover-bg);
            transform: scale(1.05);
        }
        .cal-day.not-current-month {
            color: var(--text-light);
            opacity: 0.4;
            pointer-events: none;
        }
        .cal-day.today {
            box-shadow: 0 0 0 var(--cal-today-border);
            font-weight: 600;
        }
        .cal-day .event-dot {
            position: absolute; bottom: 5px; left: 50%;
            transform: translateX(-50%);
            width: 6px; height: 6px;
            border-radius: 50%;
            transition: background-color 0.3s;
            border: 1px solid var(--widget-bg);
        }
        .cal-day .event-dot.dot-red { background-color: var(--cal-event-dot-incomplete); }
        .cal-day .event-dot.dot-yellow { background-color: var(--cal-event-dot-partial); }
        .cal-day .event-dot.dot-green { background-color: var(--cal-event-dot-complete); }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: var(--modal-overlay-bg);
            display: none; align-items: center; justify-content: center;
            z-index: 1500;
            animation: fadeIn .4s ease-out forwards;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        .modal-overlay.fade-out { animation: fadeOut .4s ease-in forwards; }
        .modal-content {
            background: var(--widget-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--widget-border-color);
            box-shadow: var(--box-shadow);
            border-radius: 16px;
            width: 90%;
            transform: scale(.8) translateY(20px);
            opacity: 0;
            animation: popIn .4s cubic-bezier(.18,.89,.32,1.28) forwards;
        }
        .modal-overlay.fade-out .modal-content { animation: popOut .4s cubic-bezier(.68,-.55,.27,1.55) forwards; }
        
        .calendar-task-tooltip {
            position: fixed; z-index: 2000;
            padding: 12px 15px; border-radius: 12px;
            pointer-events: none; max-width: 280px;
            font-size: .9em; opacity: 0;
            transform: scale(.95) translateY(5px);
            transition: opacity .2s ease,transform .2s ease;
            white-space: normal;
            background: rgba(255,255,255,0.85);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid rgba(255,255,255,0.9);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        body.dark-mode .calendar-task-tooltip {
            background: rgba(20, 25, 30, 0.85);
            border: 1px solid rgba(255,255,255,0.2);
        }
        .calendar-task-tooltip.visible {
            opacity: 1;
            transform: scale(1) translateY(0);
        }
        .calendar-task-tooltip h4 {
            margin-top: 0; margin-bottom: 8px;
            font-size: 1em; color: var(--accent-color);
            border-bottom: 1px solid var(--widget-border-color);
            padding-bottom: 5px; font-weight: 600;
        }
        .calendar-task-tooltip ul { list-style: none; padding: 0; margin: 0; }
        .calendar-task-tooltip li { padding: 5px 0; color: var(--text-light); word-break: break-word; }
        .calendar-task-tooltip li:not(:last-child) { border-bottom: 1px dashed var(--widget-border-color); }
        .calendar-task-tooltip li.completed-task { text-decoration: line-through; opacity: .7; }
        
        #moodLoggingModal .modal-content {
            max-width: 480px;
            text-align: center;
            padding: 30px;
        }
        #moodLoggingModal h3 {
            margin-top: 0; margin-bottom: 15px;
            font-size: 1.6em; color: var(--text-color);
            font-weight: 600;
        }
        #modalSelectedMoodEmoji {
            font-size: 4em;
            margin-bottom: 20px;
            text-shadow: 0 0 20px var(--accent-color-translucent);
        }
        #moodNoteInput {
            width: 100%; min-height: 90px;
            padding: 12px;
            border: 1px solid var(--widget-border-color);
            border-radius: 12px; margin-bottom: 20px;
            font-family: inherit; font-size: 1em;
            background-color: var(--input-bg);
            color: var(--text-color); outline: none;
            transition: box-shadow .2s;
        }
        #moodNoteInput:focus { box-shadow: 0 0 0 3px var(--accent-color-translucent); }
        .modal-actions {
            padding: 10px 0 0;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }
        .modal-actions button {
            padding: 12px 25px;
            border-radius: 10px;
            border: none; cursor: pointer;
            font-weight: 700; margin: 0 5px;
            transition: transform .2s,box-shadow .2s;
        }
        .modal-actions .save-mood-btn {
            background-color: var(--accent-color);
            color: #fff;
        }
        .modal-actions .cancel-mood-btn {
            background-color: var(--button-bg);
            color: var(--text-color);
        }
        .modal-actions button:hover {
            transform: translateY(-2px);
            box-shadow: var(--new-todo-btn-shadow);
        }
        
        #fullMoodLogViewModal .modal-content {
            max-width: 700px;
            height: 80vh;
            display: flex;
            flex-direction: column;
            padding: 0;
        }
        #fullMoodLogViewModal .modal-header {
            padding: 15px 20px;
            background-color: rgba(0,0,0,0.05);
            border-bottom: 1px solid var(--widget-border-color);
            border-radius: 16px 16px 0 0;
            display: flex; justify-content: space-between; align-items: center;
        }
        #fullMoodLogViewModal .modal-header h3 {
            margin: 0; font-size: 1.6em;
            font-weight: 600; color: var(--text-color);
        }
        #fullMoodLogViewModal .close-full-log-btn {
            background: none; border: none;
            font-size: 2.2em; color: var(--nav-link-color);
            cursor: pointer; line-height: 1; padding: 0 5px;
            opacity: .7; transition: opacity .2s,transform .2s;
        }
        #fullMoodLogViewModal .close-full-log-btn:hover {
            opacity: 1;
            transform: scale(1.1) rotate(90deg);
        }
        #fullMoodLogViewModal .modal-body {
            padding: 25px;
            overflow-y: auto;
            flex-grow: 1;
        }
        #fullMoodLogViewModal #fullLogListContainer { list-style: none; padding: 0; }
        #fullMoodLogViewModal #fullLogListContainer li {
            padding: 15px;
            border-bottom: 1px solid var(--widget-border-color);
            display: flex; gap: 20px;
            align-items: flex-start;
            border-radius: 12px;
            transition: background .2s;
        }
        #fullMoodLogViewModal #fullLogListContainer li:hover { background: var(--accent-color-translucent); }
        #fullMoodLogViewModal #fullLogListContainer li:last-child { border-bottom: none; }
        #fullMoodLogViewModal #fullLogListContainer .log-emoji { font-size: 2.2em; margin-top: 2px; flex-shrink: 0; }
        #fullMoodLogViewModal #fullLogListContainer .log-details { flex-grow: 1; }
        #fullMoodLogViewModal #fullLogListContainer .log-note {
            font-size: 1em; color: var(--text-color);
            margin-bottom: 8px; white-space: pre-wrap;
            word-break: break-word;
        }
        #fullMoodLogViewModal #fullLogListContainer .log-timestamp { font-size: .85em; color: var(--text-light); }
        #fullMoodLogViewModal .empty-full-log-message {
            text-align: center; padding: 40px;
            font-size: 1.1em; color: var(--text-light);
        }

        #reminderCalendarModal .modal-content { max-width: 400px; padding: 0; }
        #reminderCalendarModal .modal-header {
            padding: 15px 20px;
            background-color: rgba(0,0,0,0.05);
            border-bottom: 1px solid var(--widget-border-color);
            border-radius: 16px 16px 0 0;
            display: flex; justify-content: space-between; align-items: center;
        }
        #reminderCalendarModal #calendarMonthYear { font-weight: 700; font-size: 1.2em; }
        #reminderCalendarModal #prevMonthBtn, #reminderCalendarModal #nextMonthBtn {
            background: none; border: none;
            font-size: 2em; color: var(--text-color);
            cursor: pointer; padding: 0 10px;
            transition: transform .2s;
        }
        #reminderCalendarModal #prevMonthBtn:hover, #reminderCalendarModal #nextMonthBtn:hover { transform: scale(1.2); }
        #reminderCalendarModal #calendarGrid {
            display: grid;
            grid-template-columns: repeat(7,1fr);
            gap: 5px; padding: 20px;
        }
        #reminderCalendarModal .calendar-day-name, #reminderCalendarModal .calendar-day {
            text-align: center; padding: 8px;
            font-weight: 700; color: var(--text-light);
        }
        #reminderCalendarModal .calendar-day {
            cursor: pointer; border-radius: 50%;
            position: relative;
            transition: background-color .2s,color .2s,transform .2s;
            color: var(--text-color);
        }
        #reminderCalendarModal .calendar-day:hover {
            background-color: var(--accent-color-translucent);
            transform: scale(1.1);
        }
        #reminderCalendarModal .calendar-day.not-current-month { color: var(--text-light); opacity: .5; pointer-events: none; }
        #reminderCalendarModal .calendar-day.today { box-shadow: 0 0 0 2px solid var(--accent-color); }
        #reminderCalendarModal .calendar-day.selected {
            background-color: var(--accent-color)!important;
            color: #fff!important; font-weight: 700;
            transform: scale(1.1);
        }
        #reminderCalendarModal #reminderTimeSection { padding: 0 20px 20px; text-align: center; }
        #reminderCalendarModal #reminderTimeSection label { font-weight: 700; margin-right: 10px; }
        #reminderCalendarModal #reminderTimeInput {
            padding: 8px; border-radius: 8px;
            border: 1px solid var(--widget-border-color);
            background-color: var(--input-bg);
            color: var(--text-color); font-family: inherit;
        }

        #horoscopeModal .modal-content {
            max-width: 550px; padding: 40px;
            text-align: center; color: #fff;
            position: relative; overflow: hidden;
            background: linear-gradient(270deg, #4d2f8c, #2c3e50, #8a63d2, #463d60);
            background-size: 400% 400%;
            animation: popIn 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28) forwards, gradient-flow 15s ease infinite;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        #horoscopeModal .close-horoscope-btn {
            position: absolute; top: 10px; right: 15px;
            font-size: 2.5em; color: rgba(255, 255, 255, 0.8);
            background: none; border: none;
            cursor: pointer; line-height: 1;
            transition: transform 0.2s, color 0.2s; z-index: 1;
        }
        #horoscopeModal .close-horoscope-btn:hover { color: #fff; transform: scale(1.2); }
        #horoscopeEmoji {
            font-size: 5em; margin-bottom: 20px;
            text-shadow: 0 0 15px rgba(255, 255, 255, 0.5);
        }
        #horoscopeModalText {
            font-size: 1.4em; font-style: italic;
            font-weight: 300; line-height: 1.6;
            min-height: 120px;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5);
        }
        
        #streakModal .modal-content {
            max-width: 480px;
            text-align: center;
            padding: 25px;
        }
        #streakModal .modal-content h3 {
            display: flex; align-items: center; justify-content: center;
            gap: 10px; margin-top: 0; margin-bottom: 15px;
            font-size: 1.6em; font-weight: 600;
            color: var(--text-color);
        }
        #streakModal .modal-actions {
            justify-content: center;
            padding-top: 20px;
        }
        #streakModalMessage {
            font-size: 1.2em; color: var(--text-light);
            margin-bottom: 25px; line-height: 1.5;
        }
        .streak-week-view {
            display: flex;
            justify-content: space-around;
            gap: 10px;
        }
        .day-slot {
            display: flex; flex-direction: column;
            align-items: center; gap: 8px;
            width: 45px;
        }
        .day-slot .day-name {
            font-weight: 700; color: var(--text-light);
            font-size: .9em;
        }
        .day-slot .day-icon {
            width: 45px; height: 45px;
            border-radius: 50%;
            background-color: var(--input-bg);
            border: 2px solid var(--widget-border-color);
            display: flex; justify-content: center; align-items: center;
            font-size: 1.8em; color: transparent;
            transition: all .4s cubic-bezier(.18,.89,.32,1.28);
        }
        .day-slot.active .day-icon {
            background-color: #ff9800;
            border-color: #ffc107;
            color: #fff;
            transform: scale(1.1);
            text-shadow: 0 0 10px rgba(0,0,0,.3);
        }
        .day-slot.today .day-name {
            color: var(--accent-color);
            font-weight: 900;
        }

        /* Pomodoro Timer specific styles */
        .pomodoro-widget {
            text-align: center;
            padding: 30px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .pomodoro-widget h2 {
            font-size: 1.8em;
            color: var(--accent-color);
            margin-bottom: 10px;
        }

        #statusBar {
            display: flex;
            justify-content: center;
            margin: 10px 0 20px;
            gap: 8px;
        }
        .statusDot {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background-color: var(--progress-bar-bg); /* Light grey for inactive */
            border: 1px solid var(--widget-border-color);
            transition: background-color 0.3s;
        }
        .statusDot.active {
            background-color: var(--accent-color); /* Accent color for active sessions */
        }

        #pomodoroLabel {
            font-size: 1.5em;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 15px;
        }

        #pomodoroDisplay {
            font-family: 'Poppins', monospace;
            font-size: 5em;
            font-weight: 700;
            color: var(--accent-color);
            background: var(--input-bg);
            border: 1px solid var(--widget-border-color);
            border-radius: 15px;
            padding: 20px 0;
            margin-bottom: 25px;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.1);
            transition: color 0.3s, background-color 0.3s;
        }

        .pomodoro-controls button {
            padding: 12px 25px;
            margin: 0 8px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
            color: white;
            background-color: var(--accent-color);
            box-shadow: var(--new-todo-btn-shadow);
            transition: transform 0.2s, box-shadow 0.2s, background-color 0.2s;
        }
        .pomodoro-controls button:hover {
            transform: translateY(-3px);
            box-shadow: var(--new-todo-btn-hover-shadow);
        }
        .pomodoro-controls button#pausePomodoroBtn {
            background-color: var(--warning-color); /* Yellow for pause */
        }
        .pomodoro-controls button#resetPomodoroBtn {
            background-color: var(--danger-color); /* Red for reset */
        }

        .pomodoro-settings {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--widget-border-color);
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px 25px;
            align-items: center;
        }
        .pomodoro-settings label {
            font-size: 0.95em;
            color: var(--text-light);
            font-weight: 500;
        }
        .pomodoro-settings input[type="number"] {
            width: 70px;
            padding: 8px 12px;
            border: 1px solid var(--widget-border-color);
            border-radius: 8px;
            background-color: var(--input-bg);
            color: var(--text-color);
            font-family: 'Poppins', sans-serif;
            font-size: 0.95em;
            text-align: center;
            outline: none;
            transition: box-shadow 0.2s;
        }
        .pomodoro-settings input[type="number"]:focus {
            box-shadow: 0 0 0 3px var(--accent-color-translucent);
        }

        #sessionCounter {
            font-size: 1em;
            color: var(--text-light);
            margin-top: 20px;
            font-weight: 500;
        }


        /* Habit Tracker specific styles */
        .habit-tracker-widget {
            overflow-x: auto; /* Allow horizontal scrolling for table */
        }
        .habit-tracker-widget .add-habit-form {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .habit-tracker-widget #newHabitInput {
            flex-grow: 1;
            padding: 10px 15px;
            border: 1px solid var(--widget-border-color);
            border-radius: 10px;
            background-color: var(--input-bg);
            color: var(--text-color);
            font-size: 1em;
            outline: none;
            transition: box-shadow 0.2s;
            font-family: 'Poppins', sans-serif;
        }
        .habit-tracker-widget #newHabitInput:focus {
            box-shadow: 0 0 0 3px var(--accent-color-translucent);
        }
        .habit-tracker-widget #addHabitBtn {
            padding: 10px 20px;
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1em;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: var(--new-todo-btn-shadow);
        }
        .habit-tracker-widget #addHabitBtn:hover {
            transform: scale(1.05);
            box-shadow: var(--new-todo-btn-hover-shadow);
        }

        .habit-table-container {
            width: 100%;
            overflow-x: auto; /* Enable horizontal scrolling for the table */
        }

        .habit-table {
            width: 100%;
            border-collapse: separate; /* Use separate to allow rounded corners */
            border-spacing: 0;
            min-width: 500px; /* Ensure table doesn't shrink too much */
        }
        .habit-table th, .habit-table td {
            padding: 12px 10px;
            text-align: center;
            border-bottom: 1px solid var(--widget-border-color);
            border-right: 1px solid var(--widget-border-color);
            white-space: nowrap; /* Prevent text wrapping */
        }
        .habit-table th {
            background-color: var(--button-bg);
            font-weight: 600;
            color: var(--text-color);
            font-size: 0.9em;
            position: sticky;
            top: 0; /* Make header sticky */
            z-index: 1;
        }
        .habit-table th:first-child {
            text-align: left;
            border-top-left-radius: 12px;
        }
        .habit-table th:last-child {
            border-top-right-radius: 12px;
            border-right: none;
        }
        .habit-table tr:last-child td {
            border-bottom: none;
        }
        .habit-table td:last-child {
            border-right: none;
        }

        .habit-name-cell {
            text-align: left;
            font-weight: 500;
            color: var(--text-color);
            position: sticky;
            left: 0; /* Make habit names sticky */
            background-color: var(--widget-bg); /* Ensure background is visible when sticky */
            z-index: 1;
        }
        .habit-name-text {
            cursor: pointer;
            padding: 2px 5px;
            border-radius: 5px;
            transition: background-color 0.2s;
        }
        .habit-name-text:hover {
            background-color: var(--accent-color-translucent);
        }
        .habit-name-text:focus {
            outline: 2px solid var(--accent-color);
            outline-offset: 2px;
        }

        .daily-check input[type="checkbox"] {
            accent-color: var(--accent-color);
            width: 20px; height: 20px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .daily-check input[type="checkbox"]:hover {
            transform: scale(1.1);
        }
        .daily-check input[type="checkbox"]:checked {
            transform: scale(1.2);
        }

        .delete-habit-btn {
            background: none; border: none;
            color: var(--danger-color);
            font-size: 1.3em;
            font-weight: bold;
            cursor: pointer;
            padding: 0 5px;
            line-height: 1;
            border-radius: 50%;
            transition: color 0.2s, background-color 0.2s, transform 0.2s;
            opacity: 0.6;
            margin-left: 10px; /* Space from habit name */
        }
        .delete-habit-btn:hover {
            opacity: 1;
            color: white;
            background-color: var(--danger-color-hover);
            transform: scale(1.1);
        }

        /* Animations and Toasts */
        @keyframes fadeIn {
            from { opacity: 0; backdrop-filter: blur(0); }
            to { opacity: 1; backdrop-filter: blur(5px); }
        }
        @keyframes fadeOut {
            from { opacity: 1; backdrop-filter: blur(5px); }
            to { opacity: 0; backdrop-filter: blur(0); }
        }
        @keyframes popIn {
            from { transform: scale(.8) translateY(20px); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        @keyframes popOut {
            from { transform: scale(1); opacity: 1; }
            to { transform: scale(.8) translateY(20px); opacity: 0; }
        }
        @keyframes gradient-flow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        #confetti-container {
            position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none; overflow: hidden;
            z-index: 2000;
        }
        .confetti-piece {
            position: absolute; width: 8px;
            height: 16px; opacity: 0;
            animation: fall 3s ease-out forwards;
        }
        @keyframes fall {
            0% { opacity: 1; transform: translateY(-10vh) rotateZ(0); }
            100% { opacity: 0; transform: translateY(110vh) rotateZ(720deg); }
        }
        #toast-container {
            position: fixed; bottom: 20px; right: 20px;
            z-index: 2100; display: flex;
            flex-direction: column-reverse; gap: 10px;
        }
        .toast {
            padding: 15px 20px; border-radius: 12px;
            color: #fff; font-size: 1em; font-weight: 500;
            box-shadow: 0 4px 15px rgba(0,0,0,.2);
            transform: translateX(120%); opacity: 0;
            transition: transform .5s cubic-bezier(.18,.89,.32,1.28),opacity .5s ease;
            border: 1px solid rgba(255,255,255,.3);
            text-shadow: 1px 1px 2px rgba(0,0,0,.2);
        }
        .toast.show { transform: translateX(0); opacity: 1; }
        .toast.toast-info { background-color: var(--accent-color); }
        .toast.toast-achievement { background: linear-gradient(45deg,#ffaf07,#f44336); }
        
        /* Responsive Adjustments */
        @media (max-width: 1400px) {
            .widgets-container { grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); }
        }
        @media (max-width: 992px) {
            body { padding-left: 10px; padding-right: 10px; padding-top: 80px; }
            header { left: 10px; }
            .left-sidebar { display: none; }
            .widgets-container { grid-template-columns: 1fr; }
        }
        @media (max-width: 768px) {
            body { padding-top: 150px; }
            header { flex-direction: column; align-items: flex-start; height: auto; padding: 10px; top: 10px; left: 10px; right: 10px; }
            .logo { position: absolute; top: 10px; left: 15px; }
            header nav { margin-top: 50px; width: 100%; display: flex; justify-content: space-around; }
            .motivational-quote-banner { flex-direction: column; text-align: center; }
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">
            <label for="avatarInput" title="Click to change profile picture">
                <img id="avatarImage" src="https://cdn.vectorstock.com/i/1000v/66/13/default-avatar-profile-icon-social-media-user-vector-49816613.jpg" alt="User Avatar">
            </label>
            <button id="deleteAvatarBtn" class="delete-avatar-btn" title="Delete profile picture"></button>
            <input type="file" id="avatarInput" accept="image/png, image/jpeg, image/gif">
        </div>
        <nav>
            <a href="index.html" id="navHome">Home</a>
            <a href="about.html" id="navAbout">About Us</a>
            <a href="resources.html" id="navResources">Resources</a>
        </nav>
        <div class="search-bar">
            <input type="search" id="searchInput" placeholder="Search tasks & reminders...">
            <button id="searchButton"></button>
        </div>
    </header>

    <aside class="left-sidebar">
        <button id="newPageBtn">+ Add New List</button>
        <button class="sidebar-tab-button" id="viewMoodLogTabBtn">
            <span class="tab-icon"></span> View Full Mood Log
        </button>
        <div class="mood-tracker-launcher">
            <span class="mood-emoji-trigger" data-mood="happy" data-emoji="" title="Log Happy Mood"></span>
            <span class="mood-emoji-trigger" data-mood="sad" data-emoji="" title="Log Sad Mood"></span>
            <span class="mood-emoji-trigger" data-mood="neutral" data-emoji="" title="Log Neutral Mood"></span>
            <span class="mood-emoji-trigger" data-mood="excited" data-emoji="" title="Log Excited Mood"></span>
            <span class="mood-emoji-trigger" data-mood="stressed" data-emoji="" title="Log Stressed Mood"></span>
        </div>
        <div class="sidebar-weather">
            <div class="weather-header">
                <div id="weatherIcon"></div>
                <div class="weather-details">
                    <div id="weatherTemp">75F</div>
                    <div id="weatherCity">Kissimmee, FL</div>
                </div>
            </div>
            <p id="weatherDesc">Sunny skies today.</p>
        </div>
        <button class="sidebar-tab-button" id="sidebarStreakBtn">
            <span class="tab-icon"></span> View Streak
        </button>
        <button class="sidebar-tab-button" id="themeToggleBtn">
            <span id="themeIcon" class="tab-icon"></span>
            <span id="themeToggleText">Light/Dark Mode</span>
        </button>
        <button class="sidebar-tab-button" id="openPomodoroBtn">
            <span class="tab-icon"></span> Pomodoro Timer
        </button>
        <button class="sidebar-tab-button" id="openHabitTrackerBtn">
            <span class="tab-icon"></span> Habit Tracker
        </button>
    </aside>

    <main class="main-content">
        <section class="motivational-quote-banner">
            <p id="motivationalQuoteP">"Loading motivational quote..."</p>
        </section>
        
        <p id="noSearchResults" style="display:none; text-align:center; color: var(--text-light);">No items match your search.</p>
        
        <div class="widgets-container">
            <section class="widget reminders-widget" id="remindersWidget">
                <h2 class="drag-handle">Reminders</h2>
                <ul id="remindersList"></ul>
                <div class="add-reminder-form">
                    <input type="text" id="newReminderInput" placeholder="Type reminder, then click '+'...">
                    <button id="addReminderBtn" title="Set Date & Time for Reminder">+</button>
                </div>
            </section>
            <section class="widget calendar-widget" id="calendarWidget">
                <h2 class="drag-handle">Calendar</h2>
                <div class="calendar-header">
                    <button id="calPrevMonthBtn" class="calendar-nav-btn" title="Previous Month"><</button>
                    <h3 id="calMonthYear">Month Year</h3>
                    <button id="calNextMonthBtn" class="calendar-nav-btn" title="Next Month">></button>
                </div>
                <div id="widgetCalendarGrid" class="calendar-grid-widget"></div>
            </section>
            <section class="widget pomodoro-widget" id="pomodoroWidget" style="display:none;">
                <h2 class="drag-handle">Pomodoro Timer</h2>
                <div id="statusBar"></div>
                <h3 id="pomodoroLabel">Focus Time</h3>
                <div id="pomodoroDisplay">25:00</div>
                <div class="pomodoro-controls">
                    <button id="startPomodoroBtn"> Start</button>
                    <button id="pausePomodoroBtn" style="display:none;"> Pause</button>
                    <button id="resetPomodoroBtn"> Reset</button>
                </div>
                <div class="pomodoro-settings">
                    <div>
                        <label for="customMinutes">Focus (min): </label>
                        <input type="number" id="customMinutes" value="25" min="1" max="90">
                    </div>
                    <div>
                        <label for="breakMinutes">Break (min): </label>
                        <input type="number" id="breakMinutes" value="5" min="1" max="30">
                    </div>
                    <div>
                        <label for="totalSessions">Sessions: </label>
                        <input type="number" id="totalSessions" value="4" min="1" max="10">
                    </div>
                </div>
                <p id="sessionCounter">Session: 1 / 4</p>
                <audio id="alertSound" src="https://www.soundjay.com/buttons/beep-07.mp3" preload="auto"></audio>
            </section>
            <section class="widget habit-tracker-widget" id="habitTrackerWidget" style="display:none;">
                <h2 class="drag-handle">Habit Tracker</h2>
                <div class="add-habit-form">
                    <input type="text" id="newHabitInput" placeholder="Add new habit...">
                    <button id="addHabitBtn">Add Habit</button>
                </div>
                <div class="habit-table-container">
                    <table class="habit-table">
                        <thead>
                            <tr id="habitTableHeader">
                                <th>Habit</th>
                                <th>Sun</th>
                                <th>Mon</th>
                                <th>Tue</th>
                                <th>Wed</th>
                                <th>Thu</th>
                                <th>Fri</th>
                                <th>Sat</th>
                                <th></th> <!-- For delete button -->
                            </tr>
                        </thead>
                        <tbody id="habitTableBody">
                            <!-- Habits will be rendered here -->
                        </tbody>
                    </table>
                </div>
            </section>
        </div>
        
        <section class="horoscope-section glass">
            <div class="horoscope-header">
                <span class="horoscope-icon"></span>
                <h3>Your Daily Insight</h3>
            </div>
            <button id="getHoroscopeBtn">Reveal Today's Horoscope</button>
        </section>

        <div id="streakDisplay" class="streak-container" title="Your current streak">
            <span id="streakCount">0</span> 
            <span class="fire-icon"></span>
        </div>
    </main>

    <div id="moodLoggingModal" class="modal-overlay">
        <div class="modal-content">
            <h3>How are you feeling?</h3>
            <div id="modalSelectedMoodEmoji"></div>
            <textarea id="moodNoteInput" placeholder="Add a note (optional)..."></textarea>
            <div class="modal-actions">
                <button id="cancelMoodLogBtn" class="cancel-mood-btn">Cancel</button>
                <button id="saveMoodLogBtn" class="save-mood-btn">Log Mood</button>
            </div>
        </div>
    </div>
    
    <div id="fullMoodLogViewModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Full Mood Log</h3>
                <button id="closeFullLogViewBtn" class="close-full-log-btn" title="Close Log View"></button>
            </div>
            <div class="modal-body">
                <ul id="fullLogListContainer"></ul>
            </div>
        </div>
    </div>

    <div id="reminderCalendarModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <button id="prevMonthBtn" title="Previous Month"><</button>
                <h3 id="calendarMonthYear">Month Year</h3>
                <button id="nextMonthBtn" title="Next Month">></button>
            </div>
            <div id="calendarGrid"></div>
            <div id="reminderTimeSection">
                <label for="reminderTimeInput">Set Time:</label>
                <input type="time" id="reminderTimeInput">
            </div>
            <div class="modal-actions">
                <button id="cancelReminderBtn" class="cancel-mood-btn">Cancel</button>
                <button id="setReminderBtn" class="save-mood-btn">Set Reminder</button>
            </div>
        </div>
    </div>
    
    <div id="horoscopeModal" class="modal-overlay">
        <div class="modal-content">
            <button id="closeHoroscopeBtn" class="close-horoscope-btn" title="Close"></button>
            <div id="horoscopeEmoji"></div>
            <p id="horoscopeModalText"></p>
        </div>
    </div>
    
    <div id="streakModal" class="modal-overlay">
        <div class="modal-content">
              <h3>Your Weekly Progress </h3>
              <p id="streakModalMessage"></p>
              <div id="streakWeekView" class="streak-week-view"></div>
              <div class="modal-actions">
                  <button id="closeStreakModalBtn" class="cancel-mood-btn">Close</button>
              </div>
        </div>
    </div>
    
    <div id="confetti-container"></div>
    <div id="toast-container"></div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let todoCardsData = [];
            let reminders = [];
            let habitsData = []; // New array for habits
            let typingIntervalId = null;

            // ===== STREAK & ACHIEVEMENT CONSTANTS =====
            const streakAchievements = {
                3: " 3-Day Streak! You're building a great habit!",
                7: " 7-Day Streak! A full week of wellness!",
                14: " 14-Day Streak! You're a consistent star!",
                30: " 30-Day Streak! Incredible dedication!",
                50: " 50-Day Legend! You are a wellness superstar!"
            };

            // ===== TOAST NOTIFICATION FUNCTION =====
            function showToast(message, type = 'info') {
                const container = document.getElementById('toast-container');
                if (!container) return;
                
                const toast = document.createElement('div');
                toast.className = `toast toast-${type}`;
                toast.textContent = message;
                container.appendChild(toast);

                setTimeout(() => toast.classList.add('show'), 100);
                setTimeout(() => {
                    toast.classList.remove('show');
                    toast.addEventListener('transitionend', () => toast.remove());
                }, 4000);
            }
            
            // ===== STREAK & ACHIEVEMENT LOGIC =====
            function populateStreakModal(count, history) {
                const weekView = document.getElementById('streakWeekView');
                const messageEl = document.getElementById('streakModalMessage');
                const modal = document.getElementById('streakModal');
                if (!weekView || !messageEl || !modal) return;
                
                const modalTitle = modal.querySelector('h3');
                if (modalTitle) modalTitle.innerHTML = `Your ${count}-Day Streak `;
                
                weekView.innerHTML = '';
                messageEl.textContent = count > 1 ? `You have a ${count}-day streak. Fantastic work! Keep the fire alive.` : `Every great journey starts with a single step. Let's get this streak started!`;

                const dayNames = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];
                const today = new Date();
                const dayOfWeek = today.getDay();
                
                const startOfWeek = new Date(today);
                startOfWeek.setDate(today.getDate() - dayOfWeek);

                for (let i = 0; i < 7; i++) {
                    const dayDate = new Date(startOfWeek);
                    dayDate.setDate(startOfWeek.getDate() + i);
                    const dayStr = dayDate.toLocaleDateString('en-CA');

                    const slot = document.createElement('div');
                    slot.className = 'day-slot';
                    
                    const nameEl = document.createElement('div');
                    nameEl.className = 'day-name';
                    nameEl.textContent = dayNames[i];

                    const iconEl = document.createElement('div');
                    iconEl.className = 'day-icon';
                    iconEl.textContent = '';

                    if (history.includes(dayStr)) slot.classList.add('active');
                    if (i === dayOfWeek) slot.classList.add('today');
                    
                    slot.appendChild(iconEl);
                    slot.appendChild(nameEl);
                    weekView.appendChild(slot);
                }
            }

            function showStreakModal() {
                const streakData = JSON.parse(localStorage.getItem('streakData')) || { count: 0, loginHistory: [] };
                populateStreakModal(streakData.count, streakData.loginHistory);
                const modal = document.getElementById('streakModal');
                if (modal) {
                    modal.classList.remove('fade-out');
                    modal.style.display = 'flex';
                }
            }
            
            function checkAndAwardAchievement(count) {
                const achievementMessage = streakAchievements[count];
                if (achievementMessage) {
                    let earned = JSON.parse(localStorage.getItem('earnedAchievements')) || [];
                    if (!earned.includes(count)) {
                        showToast(achievementMessage, 'achievement');
                        earned.push(count);
                        localStorage.setItem('earnedAchievements', JSON.stringify(earned));
                    }
                }
            }

            function renderStreak(count) {
                const streakCountEl = document.getElementById('streakCount');
                if (streakCountEl) {
                    streakCountEl.textContent = count;
                }
            }

            function updateStreak() {
                const today = new Date();
                const todayStr = today.toLocaleDateString('en-CA');
                let streakData = JSON.parse(localStorage.getItem('streakData')) || { count: 0, lastLogin: null, loginHistory: [] };

                if (streakData.lastLogin === todayStr) {
                    renderStreak(streakData.count);
                    return;
                }
                
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayStr = yesterday.toLocaleDateString('en-CA');

                if (streakData.lastLogin === yesterdayStr) {
                    streakData.count++;
                } else {
                    streakData.count = 1;
                }
                
                if (!streakData.loginHistory.includes(todayStr)) {
                    streakData.loginHistory.push(todayStr);
                }
                if (streakData.loginHistory.length > 30) {
                    streakData.loginHistory = streakData.loginHistory.slice(-30);
                }
                streakData.lastLogin = todayStr;
                localStorage.setItem('streakData', JSON.stringify(streakData));

                renderStreak(streakData.count);
                checkAndAwardAchievement(streakData.count);
            }

            // ===== WEATHER WIDGET LOGIC =====
            function fetchWeather() {
                const weatherData = {
                    temp: "75F",
                    city: "Kissimmee, FL",
                    desc: "Sunny skies today.",
                    icon: ""
                };
                document.getElementById('weatherTemp').textContent = weatherData.temp;
                document.getElementById('weatherCity').textContent = weatherData.city;
                document.getElementById('weatherDesc').textContent = weatherData.desc;
                document.getElementById('weatherIcon').textContent = weatherData.icon;
            }

            // ===== AVATAR & THEME FUNCTIONALITY =====
            const avatarImage = document.getElementById('avatarImage');
            const avatarInput = document.getElementById('avatarInput');
            const deleteAvatarBtn = document.getElementById('deleteAvatarBtn');
            const defaultAvatarUrl = 'https://cdn.vectorstock.com/i/1000v/66/13/default-avatar-profile-icon-social-media-user-vector-49816613.jpg';

            function loadAvatar() {
                const savedAvatar = localStorage.getItem('userAvatar');
                avatarImage.src = savedAvatar || defaultAvatarUrl;
            }
            
            avatarInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        avatarImage.src = e.target.result;
                        localStorage.setItem('userAvatar', e.target.result);
                    };
                    reader.readAsDataURL(file);
                }
            });

            deleteAvatarBtn.addEventListener('click', () => {
                localStorage.removeItem('userAvatar');
                avatarImage.src = defaultAvatarUrl;
            });
            
            const themeToggleBtn = document.getElementById('themeToggleBtn');
            const themeIcon = document.getElementById('themeIcon');
            const body = document.body;
            const currentTheme = localStorage.getItem('theme');

            if (currentTheme === 'dark') {
                body.classList.add('dark-mode');
                themeIcon.textContent = '';
            } else {
                themeIcon.textContent = '';
            }

            themeToggleBtn.addEventListener('click', () => {
                body.classList.toggle('dark-mode');
                localStorage.setItem('theme', body.classList.contains('dark-mode') ? 'dark' : 'light');
                themeIcon.textContent = body.classList.contains('dark-mode') ? '' : '';
            });

            // ===== MOTIVATIONAL QUOTE =====
            const quotes = [
                "The only way to do great work is to love what you do.  Steve Jobs",
                "Believe you can and you're halfway there.  Theodore Roosevelt",
                "Your limitationit's only your imagination.",
                "Push yourself, because no one else is going to do it for you.",
                "Great things never come from comfort zones."
            ];
            document.getElementById('motivationalQuoteP').textContent = `"${quotes[Math.floor(Math.random() * quotes.length)]}"`;
            
            const widgetsContainer = document.querySelector('.widgets-container');

            function selectElementContents(el) {
                if(!el) return;
                const range = document.createRange();
                range.selectNodeContents(el);
                const sel = window.getSelection();
                if (sel) {
                    sel.removeAllRanges();
                    sel.addRange(range);
                }
            }

            // ===== DATA PERSISTENCE & RENDERING =====
            function saveData() {
                localStorage.setItem('todoCards', JSON.stringify(todoCardsData));
                localStorage.setItem('reminders', JSON.stringify(reminders));
                localStorage.setItem('habits', JSON.stringify(habitsData)); // Save habits
                renderCalendarWidget();
                renderHabitTracker(); // Re-render habit tracker on save
            }

            function loadData() {
                const storedTodoCards = localStorage.getItem('todoCards');
                if (storedTodoCards) todoCardsData = JSON.parse(storedTodoCards);
                const storedReminders = localStorage.getItem('reminders');
                if (storedReminders) reminders = JSON.parse(storedReminders);
                const storedHabits = localStorage.getItem('habits'); // Load habits
                if (storedHabits) habitsData = JSON.parse(storedHabits);

                renderTodoCards();
                renderReminders();
                renderCalendarWidget();
                renderHabitTracker(); // Initial render of habit tracker
            }

            // ===== TODO CARD LOGIC =====
            function renderTodoCards() {
                document.querySelectorAll('.todo-card').forEach(card => card.remove());
                todoCardsData.forEach(cardData => {
                    const cardElement = document.createElement('section');
                    cardElement.classList.add('widget', 'todo-card');
                    cardElement.id = cardData.id;
                    cardElement.innerHTML = `
                        <div class="widget-header drag-handle">
                            <h2 class="card-title"><span class="card-title-text" contenteditable="true">${cardData.title}</span></h2>
                            <button class="close-btn close-card-btn" title="Close this list"></button>
                        </div>
                        <ul class="task-list"></ul>
                        <button class="add-task-btn">+ Add New Task</button>
                        <div class="progress-item">
                            <div class="progress-bar-container"><div class="progress-bar"></div></div>
                            <p class="progress-label">0% Complete</p>
                        </div>`;
                    widgetsContainer.appendChild(cardElement);

                    cardData.tasks.forEach(task => addTaskToTodoCard(cardElement, task.text, task.completed, task.dueDate, task.id));
                    updateProgressForCard(cardElement);

                    const cardTitleText = cardElement.querySelector('.card-title-text');
                    cardTitleText.addEventListener('keydown', e => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            cardTitleText.blur();
                        }
                    });
                    cardTitleText.addEventListener('blur', () => {
                        const cardDataToUpdate = todoCardsData.find(c => c.id === cardElement.id);
                        if(cardDataToUpdate) cardDataToUpdate.title = cardTitleText.textContent.trim();
                        saveData();
                    });
                });
            }

            function createTodoCard() {
                const newCardId = `todoCard-${Date.now()}`;
                const newCardData = {
                    id: newCardId,
                    title: `Untitled List ${todoCardsData.length + 1}`,
                    tasks: []
                };
                todoCardsData.push(newCardData);
                renderTodoCards();

                const newlyCreatedCardElement = document.getElementById(newCardId);
                if (newlyCreatedCardElement) {
                    const cardTitleText = newlyCreatedCardElement.querySelector('.card-title-text');
                    newlyCreatedCardElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    cardTitleText.focus();
                    selectElementContents(cardTitleText);
                    addTaskToTodoCard(newlyCreatedCardElement, "New Task", false, '');
                }
                saveData();
            }

            function addTaskToTodoCard(cardElement, taskText = "New Task", completed = false, dueDate = '', taskId = `task-${Date.now()}-${Math.random().toString(36).substring(2, 9)}`) {
                const taskList = cardElement.querySelector('.task-list');
                const taskItem = document.createElement('li');
                taskItem.dataset.taskId = taskId;
                taskItem.innerHTML = `
                    <input type="checkbox" class="task-checkbox" ${completed ? 'checked' : ''}>
                    <div class="task-content">
                        <span class="task-label" contenteditable="true">${taskText}</span>
                        <input type="date" class="task-due-date-input" value="${dueDate}">
                    </div>
                    <button class="delete-task-btn" title="Delete Task"></button>`;
                taskList.appendChild(taskItem);

                const cardData = todoCardsData.find(card => card.id === cardElement.id);
                if (!cardData.tasks.some(t => t.id === taskId)) {
                    cardData.tasks.push({ id: taskId, text: taskText, completed: completed, dueDate: dueDate });
                }

                taskItem.querySelector('.task-label').addEventListener('blur', (e) => {
                    const task = cardData.tasks.find(t => t.id === taskId);
                    if (task) task.text = e.target.textContent.trim();
                    saveData();
                });
                taskItem.querySelector('.task-due-date-input').addEventListener('change', (e) => {
                    const task = cardData.tasks.find(t => t.id === taskId);
                    if (task) task.dueDate = e.target.value;
                    saveData();
                    checkOverdueStatus(taskItem, task.completed, task.dueDate);
                });
                taskItem.querySelector('.task-checkbox').addEventListener('change', (e) => {
                    const task = cardData.tasks.find(t => t.id === taskId);
                    if (task) task.completed = e.target.checked;
                    if (e.target.checked) triggerConfetti();
                    saveData();
                    updateProgressForCard(cardElement);
                    checkOverdueStatus(taskItem, task.completed, task.dueDate);
                });
                taskItem.querySelector('.delete-task-btn').addEventListener('click', () => {
                    const index = cardData.tasks.findIndex(t => t.id === taskId);
                    if (index > -1) cardData.tasks.splice(index, 1);
                    taskItem.remove();
                    updateProgressForCard(cardElement);
                    saveData();
                });
                checkOverdueStatus(taskItem, completed, dueDate);
                updateProgressForCard(cardElement);
            }

            function checkOverdueStatus(taskItem, completed, dueDate) {
                const taskLabel = taskItem.querySelector('.task-label');
                if (completed || !dueDate) {
                    taskLabel.classList.remove('overdue');
                    return;
                }
                const now = new Date();
                const due = new Date(dueDate);
                const nowNoTime = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const dueNoTime = new Date(due.getFullYear(), due.getMonth(), due.getDate() + 1);
                taskLabel.classList.toggle('overdue', dueNoTime < nowNoTime);
            }

            function updateProgressForCard(cardElement) {
                if (!cardElement) return;
                const checkboxes = cardElement.querySelectorAll('.task-list input[type="checkbox"]');
                const progressBar = cardElement.querySelector('.progress-bar');
                const progressLabel = cardElement.querySelector('.progress-label');
                if (!progressBar || !progressLabel) return;

                const totalTasks = checkboxes.length;
                let checkedTasks = 0;
                checkboxes.forEach(cb => {
                    const taskLabel = cb.closest('li').querySelector('.task-label');
                    if (cb.checked) {
                        checkedTasks++;
                        if (taskLabel) taskLabel.classList.add('completed');
                    } else {
                        if (taskLabel) taskLabel.classList.remove('completed');
                    }
                });
                const percentage = totalTasks === 0 ? 0 : Math.round((checkedTasks / totalTasks) * 100);
                progressBar.style.width = `${percentage}%`;
                progressLabel.textContent = `${checkedTasks} of ${totalTasks} tasks complete (${percentage}%)`;
                progressBar.style.backgroundColor = (percentage === 100 && totalTasks > 0) ? 'var(--progress-bar-fill-complete)' : (percentage < 50 ? 'var(--progress-bar-fill-1)' : 'var(--progress-bar-fill-2)');
            }

            widgetsContainer.addEventListener('click', function(event) {
                if (event.target.classList.contains('add-task-btn')) {
                    addTaskToTodoCard(event.target.closest('.todo-card'));
                    saveData();
                }
                if (event.target.classList.contains('close-card-btn')) {
                    const cardElement = event.target.closest('.todo-card');
                    todoCardsData = todoCardsData.filter(card => card.id !== cardElement.id);
                    cardElement.remove();
                    saveData();
                }
            });
            document.getElementById('newPageBtn').addEventListener('click', createTodoCard);

            // ===== REMINDERS WIDGET & MODAL LOGIC =====
            const remindersListEl = document.getElementById('remindersList');
            const newReminderInput = document.getElementById('newReminderInput');
            const addReminderBtn = document.getElementById('addReminderBtn');
            const reminderCalendarModal = document.getElementById('reminderCalendarModal');
            const calendarMonthYearEl = reminderCalendarModal.querySelector('#calendarMonthYear');
            const prevMonthBtn = reminderCalendarModal.querySelector('#prevMonthBtn');
            const nextMonthBtn = reminderCalendarModal.querySelector('#nextMonthBtn');
            const calendarGridEl = reminderCalendarModal.querySelector('#calendarGrid');
            const reminderTimeInput = reminderCalendarModal.querySelector('#reminderTimeInput');
            const setReminderBtn = reminderCalendarModal.querySelector('#setReminderBtn');
            const cancelReminderBtn = reminderCalendarModal.querySelector('#cancelReminderBtn');
            let modalCalendarDate = new Date();
            let selectedDate = null;
            let reminderTextToSet = '';

            function requestNotificationPermission() {
                if ("Notification" in window && Notification.permission === "default") {
                    Notification.requestPermission();
                }
            }

            function checkRemindersForNotification() {
                const now = new Date().getTime();
                const oneHour = 3600000;
                let needsSave = false;
                reminders.forEach(reminder => {
                    const dueDate = new Date(reminder.dueDate).getTime();
                    if (dueDate > now && (dueDate - now) <= oneHour && !reminder.completed && !reminder.notified) {
                        if (Notification.permission === "granted") new Notification("Upcoming Reminder!", { body: reminder.text });
                        reminder.notified = true;
                        needsSave = true;
                    }
                });
                if (needsSave) saveData();
            }

            function formatDueDate(dateString) {
                if (!dateString) return '';
                const date = new Date(dateString);
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const tomorrow = new Date(today);
                tomorrow.setDate(tomorrow.getDate() + 1);
                const dateToCompare = new Date(date.getFullYear(), date.getMonth(), date.getDate());
                let datePart;
                if (dateToCompare.getTime() === today.getTime()) datePart = 'Today';
                else if (dateToCompare.getTime() === tomorrow.getTime()) datePart = 'Tomorrow';
                else datePart = date.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
                const timePart = date.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit', hour12: true });
                return `${datePart} at ${timePart}`;
            }

            function renderReminders() {
                reminders.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
                remindersListEl.innerHTML = '';
                if (reminders.length === 0) {
                    remindersListEl.innerHTML = '<li style="text-align: center; color: var(--text-light); border-bottom: none; padding: 10px 0; background: transparent;">No reminders yet. Add one below!</li>';
                    return;
                }
                reminders.forEach(reminder => {
                    const li = document.createElement('li');
                    li.dataset.id = reminder.id;
                    li.innerHTML = `
                        <input type="checkbox" class="reminder-checkbox" ${reminder.completed ? 'checked' : ''}>
                        <div class="reminder-details">
                            <div class="reminder-text ${reminder.completed ? 'completed' : ''}">${reminder.text}</div>
                            <div class="reminder-date">${formatDueDate(reminder.dueDate)}</div>
                        </div>
                        <button class="delete-reminder-btn" title="Delete Reminder"></button>`;
                    li.querySelector('.reminder-checkbox').addEventListener('change', () => toggleReminderComplete(reminder.id));
                    li.querySelector('.delete-reminder-btn').addEventListener('click', () => deleteReminder(reminder.id));
                    remindersListEl.appendChild(li);
                });
            }

            function openCalendarModal() {
                reminderTextToSet = newReminderInput.value.trim();
                if (reminderTextToSet === '') {
                    showToast("Please type a reminder message first!", "info");
                    newReminderInput.focus();
                    return;
                }
                selectedDate = new Date();
                const now = new Date();
                reminderTimeInput.value = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
                generateModalCalendar();
                reminderCalendarModal.style.display = 'flex';
            }

            function closeCalendarModal() {
                reminderCalendarModal.style.display = 'none';
            }

            function generateModalCalendar() {
                calendarGridEl.innerHTML = '';
                const month = modalCalendarDate.getMonth();
                const year = modalCalendarDate.getFullYear();
                calendarMonthYearEl.textContent = `${modalCalendarDate.toLocaleString('default', { month: 'long' })} ${year}`;
                const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                dayNames.forEach(day => {
                    const dayNameEl = document.createElement('div');
                    dayNameEl.classList.add('calendar-day-name');
                    dayNameEl.textContent = day;
                    calendarGridEl.appendChild(dayNameEl);
                });

                const firstDayOfMonth = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                for (let i = 0; i < firstDayOfMonth; i++) calendarGridEl.appendChild(document.createElement('div'));

                for (let i = 1; i <= daysInMonth; i++) {
                    const dayEl = document.createElement('div');
                    dayEl.classList.add('calendar-day');
                    dayEl.textContent = i;
                    const today = new Date();
                    if (i === today.getDate() && month === today.getMonth() && year === today.getFullYear()) dayEl.classList.add('today');
                    if (selectedDate && i === selectedDate.getDate() && month === selectedDate.getMonth() && year === selectedDate.getFullYear()) dayEl.classList.add('selected');
                    dayEl.addEventListener('click', () => {
                        selectedDate = new Date(year, month, i);
                        generateModalCalendar();
                    });
                    calendarGridEl.appendChild(dayEl);
                }
            }

            prevMonthBtn.addEventListener('click', () => {
                modalCalendarDate.setMonth(modalCalendarDate.getMonth() - 1);
                generateModalCalendar();
            });
            nextMonthBtn.addEventListener('click', () => {
                modalCalendarDate.setMonth(modalCalendarDate.getMonth() + 1);
                generateModalCalendar();
            });

            function confirmAndSetReminder() {
                requestNotificationPermission();
                if (!selectedDate || !reminderTextToSet) return;
                const [hours, minutes] = reminderTimeInput.value.split(':');
                selectedDate.setHours(hours);
                selectedDate.setMinutes(minutes);
                selectedDate.setSeconds(0);
                reminders.push({
                    id: `rem-${Date.now()}`,
                    text: reminderTextToSet,
                    completed: false,
                    dueDate: selectedDate.toISOString(),
                    notified: false
                });
                renderReminders();
                newReminderInput.value = '';
                closeCalendarModal();
                saveData();
                showToast("Reminder Set!", "info");
            }

            setReminderBtn.addEventListener('click', confirmAndSetReminder);
            cancelReminderBtn.addEventListener('click', closeCalendarModal);
            
            function deleteReminder(reminderId) {
                reminders = reminders.filter(r => r.id !== reminderId);
                renderReminders();
                saveData();
            }
            
            function toggleReminderComplete(reminderId) {
                const reminder = reminders.find(r => r.id === reminderId);
                if (reminder) {
                    reminder.completed = !reminder.completed;
                    renderReminders();
                    saveData();
                }
            }

            addReminderBtn.addEventListener('click', openCalendarModal);
            newReminderInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') openCalendarModal();
            });

            // ===== CALENDAR WIDGET LOGIC =====
            const calWidgetMonthYear = document.getElementById('calMonthYear');
            const calWidgetGrid = document.getElementById('widgetCalendarGrid');
            const calWidgetPrevBtn = document.getElementById('calPrevMonthBtn');
            const calWidgetNextBtn = document.getElementById('calNextMonthBtn');
            let widgetCalendarDate = new Date();

            function renderCalendarWidget() {
                if (!calWidgetGrid) return;
                calWidgetGrid.innerHTML = '';
                const month = widgetCalendarDate.getMonth();
                const year = widgetCalendarDate.getFullYear();
                calWidgetMonthYear.textContent = `${widgetCalendarDate.toLocaleString('default', { month: 'long' })} ${year}`;
                const dayNames = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];
                dayNames.forEach(day => {
                    const dayNameEl = document.createElement('div');
                    dayNameEl.classList.add('cal-day-name');
                    dayNameEl.textContent = day;
                    calWidgetGrid.appendChild(dayNameEl);
                });
                const firstDayOfMonth = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const daysInPrevMonth = new Date(year, month, 0).getDate();

                for (let i = 0; i < firstDayOfMonth; i++) {
                    const dayEl = document.createElement('div');
                    dayEl.classList.add('cal-day', 'not-current-month');
                    dayEl.textContent = daysInPrevMonth - firstDayOfMonth + 1 + i;
                    calWidgetGrid.appendChild(dayEl);
                }
                for (let i = 1; i <= daysInMonth; i++) {
                    const dayEl = document.createElement('div');
                    dayEl.classList.add('cal-day');
                    dayEl.textContent = i;
                    const currentDateObj = new Date(year, month, i);
                    const today = new Date();
                    if (i === today.getDate() && month === today.getMonth() && year === today.getFullYear()) dayEl.classList.add('today');

                    const tasksForDay = [...reminders, ...todoCardsData.flatMap(card => card.tasks)]
                        .filter(task => {
                            if (!task.dueDate) return false;
                            const taskDate = new Date(task.dueDate);
                            return taskDate.getFullYear() === year && taskDate.getMonth() === month && taskDate.getDate() === i;
                        });
                    if (tasksForDay.length > 0) {
                        const totalTasks = tasksForDay.length;
                        const completedTasks = tasksForDay.filter(task => task.completed).length;
                        const dot = document.createElement('div');
                        dot.className = 'event-dot';
                        if (completedTasks === totalTasks) dot.classList.add('dot-green');
                        else if (completedTasks > 0) dot.classList.add('dot-yellow');
                        else dot.classList.add('dot-red');
                        dayEl.appendChild(dot);
                        dayEl.addEventListener('mouseenter', (e) => showTasksForDay(e, currentDateObj));
                        dayEl.addEventListener('mouseleave', hideTaskTooltip);
                    }

                    calWidgetGrid.appendChild(dayEl);
                }
            }

            if (calWidgetPrevBtn) calWidgetPrevBtn.addEventListener('click', () => {
                widgetCalendarDate.setMonth(widgetCalendarDate.getMonth() - 1);
                renderCalendarWidget();
            });
            if (calWidgetNextBtn) calWidgetNextBtn.addEventListener('click', () => {
                widgetCalendarDate.setMonth(widgetCalendarDate.getMonth() + 1);
                renderCalendarWidget();
            });

            function showTasksForDay(event, date) {
                const oldTooltip = document.getElementById('calendar-tooltip');
                if (oldTooltip) oldTooltip.remove();
                const targetDate = new Date(date);
                const isSameDay = (d) => d.getFullYear() === targetDate.getFullYear() && d.getMonth() === targetDate.getMonth() && d.getDate() === targetDate.getDate();
                const dailyTasks = [...reminders, ...todoCardsData.flatMap(card => card.tasks)]
                    .filter(task => task.dueDate && isSameDay(new Date(task.dueDate)));
                if (dailyTasks.length === 0) return;

                const tooltip = document.createElement('div');
                tooltip.id = 'calendar-tooltip';
                tooltip.className = 'calendar-task-tooltip';
                const taskListHtml = dailyTasks.map(t => `<li class="${t.completed ? 'completed-task' : ''}">${t.text}</li>`).join('');
                tooltip.innerHTML = `<h4>Tasks for ${targetDate.toLocaleDateString(undefined, { month: 'short', day: 'numeric' })}</h4><ul>${taskListHtml}</ul>`;
                document.body.appendChild(tooltip);
                tooltip.style.position = 'fixed';
                tooltip.style.left = `${event.clientX + 15}px`;
                tooltip.style.top = `${event.clientY + 10}px`;
                setTimeout(() => tooltip.classList.add('visible'), 10);
            }

            function hideTaskTooltip() {
                const existingTooltip = document.getElementById('calendar-tooltip');
                if (existingTooltip) {
                    existingTooltip.classList.remove('visible');
                    setTimeout(() => {
                        if (existingTooltip.parentElement) existingTooltip.remove();
                    }, 200);
                }
            }
            
            // ===== MOOD TRACKER LOGIC =====
            const moodEmojiTriggers = document.querySelectorAll('.mood-emoji-trigger');
            const moodLoggingModal = document.getElementById('moodLoggingModal');
            const modalSelectedMoodEmoji = document.getElementById('modalSelectedMoodEmoji');
            const moodNoteInput = document.getElementById('moodNoteInput');
            const saveMoodLogBtn = document.getElementById('saveMoodLogBtn');
            const cancelMoodLogBtn = document.getElementById('cancelMoodLogBtn');
            const viewMoodLogTabBtn = document.getElementById('viewMoodLogTabBtn');
            const fullMoodLogViewModal = document.getElementById('fullMoodLogViewModal');
            const closeFullLogViewBtn = document.getElementById('closeFullLogViewBtn');
            const fullLogListContainer = document.getElementById('fullLogListContainer');
            let currentSelectedMood = { type: '', emoji: '' };

            function openMoodModal(moodType, moodEmoji) {
                currentSelectedMood.type = moodType;
                currentSelectedMood.emoji = moodEmoji;
                modalSelectedMoodEmoji.textContent = moodEmoji;
                moodNoteInput.value = '';
                moodLoggingModal.classList.remove('fade-out');
                moodLoggingModal.style.display = 'flex';
                moodNoteInput.focus();
            }

            function closeMoodModal() {
                moodLoggingModal.classList.add('fade-out');
                setTimeout(() => {
                    moodLoggingModal.style.display = 'none';
                }, 400);
            }

            moodEmojiTriggers.forEach(trigger => {
                trigger.addEventListener('click', function() {
                    openMoodModal(this.dataset.mood, this.dataset.emoji);
                });
            });

            saveMoodLogBtn.addEventListener('click', () => {
                const note = moodNoteInput.value.trim();
                const timestamp = new Date();
                const moodEntry = {
                    mood: currentSelectedMood.type,
                    emoji: currentSelectedMood.emoji,
                    note: note,
                    timestamp: timestamp.toISOString()
                };
                saveMoodEntry(moodEntry);
                if (fullMoodLogViewModal.style.display === 'flex') renderFullMoodLog();
                closeMoodModal();
            });

            cancelMoodLogBtn.addEventListener('click', closeMoodModal);

            function getMoodLog() {
                return JSON.parse(localStorage.getItem('moodLog') || '[]');
            }

            function saveMoodEntry(entry) {
                const log = getMoodLog();
                log.unshift(entry);
                localStorage.setItem('moodLog', JSON.stringify(log));
            }

            function renderFullMoodLog() {
                const log = getMoodLog();
                fullLogListContainer.innerHTML = '';
                if (log.length === 0) {
                    fullLogListContainer.innerHTML = '<p class="empty-full-log-message">Your mood log is empty. Start logging your mood using the emojis!</p>';
                    return;
                }
                log.forEach(entry => {
                    const li = document.createElement('li');
                    const entryDate = new Date(entry.timestamp);
                    const formattedTimestamp = entryDate.toLocaleString(undefined, {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    li.innerHTML = `
                        <span class="log-emoji">${entry.emoji}</span>
                        <div class="log-details">
                            <p class="log-note">${entry.note || '<em>No note added.</em>'}</p>
                            <p class="log-timestamp">Logged: ${formattedTimestamp}</p>
                        </div>`;
                    fullLogListContainer.appendChild(li);
                });
            }
            
            function closeFullLogViewModal() {
                fullMoodLogViewModal.classList.add('fade-out');
                setTimeout(() => {
                    fullMoodLogViewModal.style.display = 'none';
                }, 400);
            }

            viewMoodLogTabBtn.addEventListener('click', () => {
                renderFullMoodLog();
                fullMoodLogViewModal.classList.remove('fade-out');
                fullMoodLogViewModal.style.display = 'flex';
            });

            closeFullLogViewBtn.addEventListener('click', closeFullLogViewModal);

            // ===== HOROSCOPE MODAL LOGIC =====
            const getHoroscopeBtn = document.getElementById('getHoroscopeBtn');
            const horoscopeModal = document.getElementById('horoscopeModal');
            const closeHoroscopeBtn = document.getElementById('closeHoroscopeBtn');
            const horoscopeEmojiEl = document.getElementById('horoscopeEmoji');
            const horoscopeModalTextEl = document.getElementById('horoscopeModalText');

            const horoscopeData = [
                { emoji: "", quote: "A burst of energy finds you today. Channel it into a project you're passionate about!" },
                { emoji: "", quote: "Patience is your ally. A slow and steady approach will lead to sweet success." },
                { emoji: "", quote: "Your curiosity is your superpower. Ask questions and explore a new idea." },
                { emoji: "", quote: "Listen to your heart. Your intuition is guiding you toward a comforting truth." },
                { emoji: "", quote: "Don't be afraid to shine! Your natural charisma will open doors for you today." },
                { emoji: "", quote: "A small act of organization will bring you great peace of mind. Tidy up your space or your schedule." },
                { emoji: "", quote: "Seek balance in all things. A compromise will lead to a harmonious outcome." },
                { emoji: "", quote: "A hidden truth may be revealed. Trust your instincts and look beneath the surface." },
                { emoji: "", quote: "Adventure is calling! Even a small change in routine can feel like a grand journey." },
                { emoji: "", quote: "Your discipline is admirable. A focused effort will bring you closer to a long-term goal." },
                { emoji: "", quote: "Think outside the box. A unique solution is needed for an old problem." },
                { emoji: "", quote: "Let your imagination wander. Creativity and dreams hold the key to your day." }
            ];

            function typeOutText(element, text) {
                element.textContent = '';
                let charIndex = 0;
                if (typingIntervalId) clearInterval(typingIntervalId);

                typingIntervalId = setInterval(() => {
                    if (charIndex < text.length) {
                        element.textContent += text.charAt(charIndex);
                        charIndex++;
                    } else {
                        clearInterval(typingIntervalId);
                        typingIntervalId = null;
                    }
                }, 40);
            }

            function openHoroscopeModal(emoji, text) {
                horoscopeEmojiEl.textContent = emoji;
                typeOutText(horoscopeModalTextEl, text);
                horoscopeModal.classList.remove('fade-out');
                horoscopeModal.style.display = 'flex';
            }

            function closeHoroscopeModal() {
                horoscopeModal.classList.add('fade-out');
                setTimeout(() => {
                    horoscopeModal.style.display = 'none';
                    if (typingIntervalId) {
                        clearInterval(typingIntervalId);
                        typingIntervalId = null;
                    }
                }, 400);
            }

            getHoroscopeBtn.addEventListener('click', () => {
                const TWENTY_FOUR_HOURS_IN_MS = 864e5;
                const now = Date.now();
                const lastFetchTime = parseInt(localStorage.getItem('horoscopeFetchTime') || '0');

                if (!lastFetchTime || (now - lastFetchTime > TWENTY_FOUR_HOURS_IN_MS)) {
                    const newHoroscope = horoscopeData[Math.floor(Math.random() * horoscopeData.length)];
                    localStorage.setItem('dailyHoroscope', newHoroscope.quote);
                    localStorage.setItem('dailyEmoji', newHoroscope.emoji);
                    localStorage.setItem('horoscopeFetchTime', now.toString());
                    openHoroscopeModal(newHoroscope.emoji, newHoroscope.quote);
                } else {
                    const savedHoroscope = localStorage.getItem('dailyHoroscope');
                    const savedEmoji = localStorage.getItem('dailyEmoji');
                    openHoroscopeModal(savedEmoji, savedHoroscope);
                }
            });

            closeHoroscopeBtn.addEventListener('click', closeHoroscopeModal);
            
            // ===== UNIVERSAL MODAL & CONFETTI LOGIC =====
            const closeStreakModalBtn = document.getElementById('closeStreakModalBtn');
            if (closeStreakModalBtn) {
                closeStreakModalBtn.addEventListener('click', () => {
                    const modal = document.getElementById('streakModal');
                    if (modal) {
                        modal.classList.add('fade-out');
                        setTimeout(() => {
                            modal.style.display = 'none';
                            modal.classList.remove('fade-out');
                        }, 400);
                    }
                });
            }

            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.addEventListener('click', (event) => {
                    if (event.target === modal) {
                        if (modal.id === 'fullMoodLogViewModal') closeFullLogViewModal();
                        if (modal.id === 'moodLoggingModal') closeMoodModal();
                        if (modal.id === 'reminderCalendarModal') closeCalendarModal();
                        if (modal.id === 'horoscopeModal') closeHoroscopeModal();
                        if (modal.id === 'streakModal' && closeStreakModalBtn) closeStreakModalBtn.click();
                    }
                });
            });

            function triggerConfetti() {
                const confettiContainer = document.getElementById('confetti-container');
                if (!confettiContainer) return;
                for (let i = 0; i < 50; i++) {
                    const piece = document.createElement('div');
                    piece.classList.add('confetti-piece');
                    piece.style.left = `${Math.random() * 100}vw`;
                    const colors = ['#6C63FF', '#2ecc71', '#3498db', '#e74c3c', '#f1c40f'];
                    piece.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    piece.style.animationDelay = `${Math.random() * 0.5}s`;
                    confettiContainer.appendChild(piece);
                    setTimeout(() => piece.remove(), 3500);
                }
            }

            // ===== DRAG & DROP WIDGETS =====
            function applyWidgetOrder() {
                const widgetsContainer = document.querySelector('.widgets-container');
                try {
                    const widgetOrder = JSON.parse(localStorage.getItem('widgetOrder'));
                    if (widgetOrder && Array.isArray(widgetOrder) && widgetsContainer) {
                        const widgetMap = new Map();
                        [...widgetsContainer.children].forEach(child => {
                            if (child.id) {
                                widgetMap.set(child.id, child);
                            }
                        });
                        widgetOrder.forEach(widgetId => {
                            const widgetElement = widgetMap.get(widgetId);
                            if (widgetElement) {
                                widgetsContainer.appendChild(widgetElement);
                            }
                        });
                    }
                } catch (e) {
                    console.error("Failed to parse or apply widget order:", e);
                    localStorage.removeItem('widgetOrder');
                }
            }

            function initializeDragAndDrop() {
                const widgetsContainer = document.querySelector('.widgets-container');
                if (widgetsContainer && typeof Sortable !== 'undefined') {
                    new Sortable(widgetsContainer, {
                        animation: 200,
                        draggable: '.widget',
                        handle: '.drag-handle',
                        ghostClass: 'sortable-ghost',
                        onEnd: function() {
                            const widgetOrder = [...widgetsContainer.children].map(widget => widget.id).filter(id => id);
                            localStorage.setItem('widgetOrder', JSON.stringify(widgetOrder));
                        }
                    });
                    applyWidgetOrder();
                }
            }

            // ===== SEARCH FUNCTIONALITY =====
            function performSearch(query) {
                query = query.toLowerCase().trim();
                const noResultsEl = document.getElementById('noSearchResults');
                let anyResultsFound = false;

                const applyVisibility = (element, show) => {
                    if (!element.style.transition) {
                        element.style.transition = 'opacity 0.4s ease';
                    }
                    element.style.opacity = show ? '1' : '0.2';
                    element.style.pointerEvents = show ? 'auto' : 'none';
                    element.style.display = show ? '' : 'none'; // Also set display to none to remove from layout
                };

                if (query === '') {
                    document.querySelectorAll('.reminders-widget, .todo-card, .habit-tracker-widget, .pomodoro-widget, #remindersList li, .todo-card .task-list li, .habit-table tbody tr').forEach(el => applyVisibility(el, true));
                    applyVisibility(document.getElementById('calendarWidget'), true);
                    if (noResultsEl) noResultsEl.style.display = 'none';
                    return;
                }

                const remindersWidget = document.getElementById('remindersWidget');
                let remindersVisible = false;
                remindersWidget.querySelectorAll('li').forEach(li => {
                    const text = li.querySelector('.reminder-text')?.textContent.toLowerCase();
                    const match = text && text.includes(query);
                    applyVisibility(li, match);
                    if (match) remindersVisible = true;
                });
                applyVisibility(remindersWidget, remindersVisible);
                if (remindersVisible) anyResultsFound = true;

                document.querySelectorAll('.todo-card').forEach(card => {
                    const title = card.querySelector('.card-title-text')?.textContent.toLowerCase();
                    const titleMatches = title && title.includes(query);
                    let hasVisibleTask = false;
                    card.querySelectorAll('.task-list li').forEach(taskLi => {
                        const label = taskLi.querySelector('.task-label')?.textContent.toLowerCase();
                        const taskMatches = label && label.includes(query);
                        const isVisible = titleMatches || taskMatches;
                        applyVisibility(taskLi, isVisible);
                        if (isVisible) hasVisibleTask = true;
                    });
                    const showCard = titleMatches || hasVisibleTask;
                    applyVisibility(card, showCard);
                    if (showCard) anyResultsFound = true;
                });

                const habitTrackerWidget = document.getElementById('habitTrackerWidget');
                let habitsVisible = false;
                habitTrackerWidget.querySelectorAll('.habit-table tbody tr').forEach(habitRow => {
                    const habitName = habitRow.querySelector('.habit-name-text')?.textContent.toLowerCase();
                    const match = habitName && habitName.includes(query);
                    applyVisibility(habitRow, match);
                    if (match) habitsVisible = true;
                });
                applyVisibility(habitTrackerWidget, habitsVisible);
                if (habitsVisible) anyResultsFound = true;

                // For Pomodoro widget, if it's not explicitly searched, it should be hidden
                const pomodoroWidget = document.getElementById('pomodoroWidget');
                if (pomodoroWidget) {
                    const pomodoroTitle = pomodoroWidget.querySelector('h2')?.textContent.toLowerCase();
                    const pomodoroMatches = pomodoroTitle && pomodoroTitle.includes(query);
                    applyVisibility(pomodoroWidget, pomodoroMatches);
                    if (pomodoroMatches) anyResultsFound = true;
                }


                if (noResultsEl) {
                    noResultsEl.style.display = anyResultsFound ? 'none' : 'block';
                }
            }

            // ===== HABIT TRACKER LOGIC =====
            const habitTableBody = document.getElementById('habitTableBody');
            const newHabitInput = document.getElementById('newHabitInput');
            const addHabitBtn = document.getElementById('addHabitBtn');
            const openHabitTrackerBtn = document.getElementById('openHabitTrackerBtn'); // Sidebar button
            const habitTrackerWidget = document.getElementById('habitTrackerWidget'); // The widget itself

            function renderHabitTracker() {
                habitTableBody.innerHTML = '';
                const today = new Date();
                const currentDayIndex = today.getDay(); // 0 for Sunday, 1 for Monday, ..., 6 for Saturday

                habitsData.forEach(habit => {
                    const row = document.createElement('tr');
                    row.dataset.habitId = habit.id;

                    const habitNameCell = document.createElement('td');
                    habitNameCell.classList.add('habit-name-cell');
                    habitNameCell.innerHTML = `<span class="habit-name-text" contenteditable="true">${habit.name}</span>`;
                    
                    // Add blur listener for editing habit name
                    habitNameCell.querySelector('.habit-name-text').addEventListener('blur', (e) => {
                        const updatedName = e.target.textContent.trim();
                        const habitToUpdate = habitsData.find(h => h.id === habit.id);
                        if (habitToUpdate && updatedName !== '') {
                            habitToUpdate.name = updatedName;
                            saveData();
                        } else if (updatedName === '') {
                            e.target.textContent = habit.name; // Revert if empty
                        }
                    });
                    // Prevent new line on Enter key
                    habitNameCell.querySelector('.habit-name-text').addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            e.target.blur();
                        }
                    });

                    row.appendChild(habitNameCell);

                    for (let i = 0; i < 7; i++) {
                        const dayCell = document.createElement('td');
                        dayCell.classList.add('daily-check');
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.dataset.dayIndex = i;
                        checkbox.checked = habit.dailyCompletion[i];
                        
                        // Disable checkboxes for future days
                        if (i > currentDayIndex) {
                            checkbox.disabled = true;
                        }

                        checkbox.addEventListener('change', (e) => {
                            toggleHabitCompletion(habit.id, i, e.target.checked);
                        });
                        dayCell.appendChild(checkbox);
                        row.appendChild(dayCell);
                    }

                    const deleteCell = document.createElement('td');
                    const deleteBtn = document.createElement('button');
                    deleteBtn.classList.add('delete-habit-btn');
                    deleteBtn.textContent = '';
                    deleteBtn.title = 'Delete Habit';
                    deleteBtn.addEventListener('click', () => deleteHabit(habit.id));
                    deleteCell.appendChild(deleteBtn);
                    row.appendChild(deleteCell);

                    habitTableBody.appendChild(row);
                });
            }

            function addHabit() {
                const habitName = newHabitInput.value.trim();
                if (habitName) {
                    const newHabit = {
                        id: `habit-${Date.now()}`,
                        name: habitName,
                        dailyCompletion: Array(7).fill(false) // 0:Sun, 1:Mon, ..., 6:Sat
                    };
                    habitsData.push(newHabit);
                    newHabitInput.value = '';
                    saveData(); // Save and re-render
                    showToast(`Habit "${habitName}" added!`, 'info');
                } else {
                    showToast("Please enter a habit name.", "info");
                }
            }

            function toggleHabitCompletion(habitId, dayIndex, isChecked) {
                const habit = habitsData.find(h => h.id === habitId);
                if (habit) {
                    habit.dailyCompletion[dayIndex] = isChecked;
                    saveData(); // Save and re-render
                }
            }

            function deleteHabit(habitId) {
                habitsData = habitsData.filter(h => h.id !== habitId);
                saveData(); // Save and re-render
                showToast("Habit deleted!", "info");
            }

            // Function to reset daily completion for a new day
            function resetDailyHabits() {
                const lastResetDate = localStorage.getItem('lastHabitResetDate');
                const today = new Date().toLocaleDateString('en-CA');

                if (lastResetDate !== today) {
                    habitsData.forEach(habit => {
                        // Reset all checkboxes for the new day
                        habit.dailyCompletion = Array(7).fill(false); 
                    });
                    localStorage.setItem('lastHabitResetDate', today);
                    saveData(); // Save and re-render after reset
                    showToast("Habit checkboxes reset for the new day!", "info");
                }
            }

            // Toggle visibility of Habit Tracker widget
            openHabitTrackerBtn.addEventListener('click', () => {
                if (habitTrackerWidget.style.display === 'none') {
                    habitTrackerWidget.style.display = 'flex';
                    habitTrackerWidget.scrollIntoView({ behavior: 'smooth', block: 'center' });
                } else {
                    habitTrackerWidget.style.display = 'none';
                }
            });

            // ===== POMODORO TIMER LOGIC =====
            let pomodoroInterval;
            let isRunning = false;
            let defaultFocusMinutes = 25;
            let defaultBreakMinutes = 5;
            let totalSessionLimit = 4;
            let isBreak = false;
            let timeLeft = defaultFocusMinutes * 60;
            let sessionCount = 1;
            
            const pomodoroWidget = document.getElementById("pomodoroWidget");
            const openPomodoroBtn = document.getElementById("openPomodoroBtn");
            const startBtn = document.getElementById("startPomodoroBtn");
            const pauseBtn = document.getElementById("pausePomodoroBtn");
            const resetBtn = document.getElementById("resetPomodoroBtn");
            const display = document.getElementById("pomodoroDisplay");
            const label = document.getElementById("pomodoroLabel");
            const customMinutesInput = document.getElementById("customMinutes");
            const breakMinutesInput = document.getElementById("breakMinutes");
            const sessionCounter = document.getElementById("sessionCounter");
            const totalSessionsInput = document.getElementById("totalSessions");
            const alertSound = document.getElementById("alertSound");
            const statusBar = document.getElementById("statusBar");

            function savePomodoroState() {
                localStorage.setItem('pomodoroFocusMinutes', defaultFocusMinutes.toString());
                localStorage.setItem('pomodoroBreakMinutes', defaultBreakMinutes.toString());
                localStorage.setItem('pomodoroTotalSessions', totalSessionLimit.toString());
                localStorage.setItem('pomodoroIsBreak', isBreak.toString());
                localStorage.setItem('pomodoroTimeLeft', timeLeft.toString());
                localStorage.setItem('pomodoroSessionCount', sessionCount.toString());
                localStorage.setItem('pomodoroIsRunning', isRunning.toString());
            }

            function loadPomodoroState() {
                defaultFocusMinutes = parseInt(localStorage.getItem('pomodoroFocusMinutes') || '25');
                defaultBreakMinutes = parseInt(localStorage.getItem('pomodoroBreakMinutes') || '5');
                totalSessionLimit = parseInt(localStorage.getItem('pomodoroTotalSessions') || '4');
                isBreak = localStorage.getItem('pomodoroIsBreak') === 'true';
                timeLeft = parseInt(localStorage.getItem('pomodoroTimeLeft') || (defaultFocusMinutes * 60).toString());
                sessionCount = parseInt(localStorage.getItem('pomodoroSessionCount') || '1');
                isRunning = localStorage.getItem('pomodoroIsRunning') === 'true';

                customMinutesInput.value = defaultFocusMinutes;
                breakMinutesInput.value = defaultBreakMinutes;
                totalSessionsInput.value = totalSessionLimit;

                label.textContent = isBreak ? "Break Time" : "Focus Time";
                updateDisplay();
                updateSession();

                if (isRunning) {
                    startTimer(); // Restart timer if it was running
                } else {
                    startBtn.style.display = "inline";
                    pauseBtn.style.display = "none";
                }
            }
            
            function renderStatusBar() {
                statusBar.innerHTML = "";
                for (let i = 1; i <= totalSessionLimit; i++) {
                    const dot = document.createElement("div");
                    dot.classList.add("statusDot");
                    if (i < sessionCount || (i === sessionCount && isBreak)) {
                        dot.classList.add("active");
                    }
                    statusBar.appendChild(dot);
                }
            }
            
            customMinutesInput.addEventListener("change", () => {
                defaultFocusMinutes = parseInt(customMinutesInput.value) || 25;
                if (!isBreak) resetTimer();
                savePomodoroState();
            });
            
            breakMinutesInput.addEventListener("change", () => {
                defaultBreakMinutes = parseInt(breakMinutesInput.value) || 5;
                if (isBreak) resetTimer();
                savePomodoroState();
            });
            
            totalSessionsInput.addEventListener("change", () => {
                totalSessionLimit = parseInt(totalSessionsInput.value) || 4;
                if (sessionCount > totalSessionLimit) sessionCount = totalSessionLimit;
                updateSession();
                savePomodoroState();
            });
            
            function updateDisplay() {
                const minutes = String(Math.floor(timeLeft / 60)).padStart(2, "0");
                const seconds = String(timeLeft % 60).padStart(2, "0");
                display.textContent = `${minutes}:${seconds}`;
            }
            
            function updateSession() {
                sessionCounter.textContent = `Session: ${sessionCount} / ${totalSessionLimit}`;
                renderStatusBar();
            }
            
            function playSound() {
                if (alertSound) {
                    alertSound.currentTime = 0;
                    alertSound.play();
                }
            }
            
            function showCustomAlert(message) {
                const alertDiv = document.createElement('div');
                alertDiv.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background-color: var(--widget-bg);
                    border: 1px solid var(--widget-border-color);
                    border-radius: 16px;
                    padding: 20px 30px;
                    box-shadow: var(--box-shadow);
                    z-index: 2000;
                    font-family: 'Poppins', sans-serif;
                    color: var(--text-color);
                    text-align: center;
                    display: flex;
                    flex-direction: column;
                    gap: 15px;
                    max-width: 300px;
                    animation: fadeIn 0.3s ease-out forwards;
                `;
                alertDiv.innerHTML = `
                    <p>${message}</p>
                    <button style="
                        padding: 8px 15px;
                        background-color: var(--accent-color);
                        color: white;
                        border: none;
                        border-radius: 8px;
                        cursor: pointer;
                        font-weight: bold;
                        font-size: 1em;
                        transition: transform 0.2s, box-shadow 0.2s;
                    " onclick="this.parentElement.remove()">OK</button>
                `;
                document.body.appendChild(alertDiv);
            }

            function startTimer() {
                if (!isRunning && sessionCount <= totalSessionLimit) {
                    isRunning = true;
                    pomodoroInterval = setInterval(() => {
                        if (timeLeft > 0) {
                            timeLeft--;
                            updateDisplay();
                            savePomodoroState();
                        } else {
                            clearInterval(pomodoroInterval);
                            isRunning = false;
                            playSound();
                            if (!isBreak && sessionCount >= totalSessionLimit) {
                                showCustomAlert("All sessions complete!");
                                resetTimerFull();
                                return;
                            }
                            isBreak = !isBreak;
                            if (isBreak) {
                                showCustomAlert("Break time! Relax.");
                                label.textContent = "Break Time";
                                timeLeft = defaultBreakMinutes * 60;
                            } else {
                                showCustomAlert("Back to work!");
                                sessionCount++;
                                updateSession();
                                label.textContent = "Focus Time";
                                timeLeft = defaultFocusMinutes * 60;
                            }
                            updateDisplay();
                            savePomodoroState();
                            startTimer();
                        }
                    }, 1000);
                    startBtn.style.display = "none";
                    pauseBtn.style.display = "inline";
                }
            }
            
            function pauseTimer() {
                clearInterval(pomodoroInterval);
                isRunning = false;
                startBtn.style.display = "inline";
                pauseBtn.style.display = "none";
                savePomodoroState();
            }
            
            function resetTimer() {
                clearInterval(pomodoroInterval);
                timeLeft = (isBreak ? defaultBreakMinutes : defaultFocusMinutes) * 60;
                label.textContent = isBreak ? "Break Time" : "Focus Time";
                isRunning = false;
                updateDisplay();
                startBtn.style.display = "inline";
                pauseBtn.style.display = "none";
                savePomodoroState();
            }

            function resetTimerFull() {
                clearInterval(pomodoroInterval);
                isRunning = false;
                isBreak = false;
                sessionCount = 1;
                timeLeft = defaultFocusMinutes * 60;
                label.textContent = "Focus Time";
                updateDisplay();
                updateSession();
                startBtn.style.display = "inline";
                pauseBtn.style.display = "none";
                savePomodoroState(); // Save initial state
            }
            
            startBtn.addEventListener("click", startTimer);
            pauseBtn.addEventListener("click", pauseTimer);
            resetBtn.addEventListener("click", resetTimerFull);

            // Toggle visibility of Pomodoro widget
            openPomodoroBtn.addEventListener("click", () => {
                if (pomodoroWidget.style.display === "none") {
                    pomodoroWidget.style.display = "flex";
                    pomodoroWidget.scrollIntoView({ behavior: 'smooth', block: 'center' });
                } else {
                    pomodoroWidget.style.display = "none";
                }
            });

            // ===== EVENT LISTENERS & INITIALIZATION =====
            document.getElementById('sidebarStreakBtn')?.addEventListener('click', showStreakModal);
            
            const searchInput = document.getElementById('searchInput');
            const searchButton = document.getElementById('searchButton');
            searchInput?.addEventListener('input', () => performSearch(searchInput.value));
            searchButton?.addEventListener('click', () => performSearch(searchInput.value));

            // Habit Tracker Event Listeners
            addHabitBtn.addEventListener('click', addHabit);
            newHabitInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    addHabit();
                }
            });

            // --- INITIALIZATION SEQUENCE ---
            updateStreak();
            fetchWeather();
            setInterval(checkRemindersForNotification, 60000);
            checkRemindersForNotification();
            loadData(); // Load all data including habits
            initializeDragAndDrop();
            loadAvatar();
            resetDailyHabits(); // Check and reset habits at the start of a new day
            loadPomodoroState(); // Load Pomodoro state on page load
        });
    </script>
</body>
</html>
